<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1, user-scalable=no">
    <meta name="description" content="× ×™×”×•×œ × ×›×¡×™× ×¤×™× × ×¡×™×™× - ×¤× ×¡×™×”, ×’××œ, ×”×©×§×¢×•×ª ×•×¢×•×“">
    <meta name="theme-color" content="#0a0e27">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="×¤×•×¨×˜×¤×•×œ×™×•">
    <meta name="theme-color" content="#0a0e27">
    <meta name="color-scheme" content="dark">
    <title>×œ×•×— ×‘×§×¨×” ×¤×™× × ×¡×™ - Portfolio Dashboard</title>
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/svg+xml" href="./logo.svg">
    <link rel="apple-touch-icon" href="./logo.svg">
    <link href="https://fonts.googleapis.com/css2?family=Alef:wght@400;700&family=Rubik:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e27;
            --bg-secondary: #141829;
            --bg-card: #1a1f3a;
            --bg-hover: #222847;
            --text-primary: #e8eaf6;
            --text-secondary: #9ca3af;
            --accent-gold: #f4c430;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-blue: #3b82f6;
            --border-color: #2d3348;
            --shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        body {
            font-family: 'Rubik', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #141829 50%, #0a0e27 100%);
            background-attachment: fixed;
            color: var(--text-primary);
            min-height: 100vh;
            min-height: -webkit-fill-available;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top, 0px));
            padding-bottom: calc(20px + env(safe-area-inset-bottom, 0px));
            padding-left: calc(20px + env(safe-area-inset-left, 0px));
            padding-right: calc(20px + env(safe-area-inset-right, 0px));
            -webkit-overflow-scrolling: touch;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overscroll-behavior-y: contain;
        }

        html {
            height: -webkit-fill-available;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(circle at 20% 50%, rgba(244, 196, 48, 0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(59, 130, 246, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .header {
            margin-bottom: 40px;
            animation: fadeInDown 0.8s ease-out;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #ffd700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -1px;
        }

        .last-update {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .total-worth-card {
            background: linear-gradient(135deg, #1a1f3a 0%, #252b4a 100%);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 40px;
            box-shadow: var(--shadow);
            animation: fadeInUp 0.8s ease-out 0.1s both;
            position: relative;
            overflow: hidden;
        }

        .total-worth-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(244, 196, 48, 0.1) 0%, transparent 70%);
            animation: rotateCard 20s linear infinite;
        }

        @keyframes rotateCard {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .total-worth-content {
            position: relative;
            z-index: 1;
            text-align: center;
        }

        .total-label {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 500;
        }

        .total-amount {
            font-size: 4rem;
            font-weight: 700;
            color: var(--accent-gold);
            margin-bottom: 20px;
            text-shadow: 0 0 30px rgba(244, 196, 48, 0.3);
        }

        .total-change {
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .total-change.positive {
            color: var(--accent-green);
        }

        .total-change.negative {
            color: var(--accent-red);
        }

        .assets-grid {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 40px;
        }

        .asset-row {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(26, 31, 58, 0.8) 100%);
            border: 1px solid var(--border-color);
            border-radius: 14px;
            padding: 16px 20px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            animation: fadeInUp 0.5s ease-out both;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .asset-row:hover {
            border-color: rgba(244, 196, 48, 0.4);
            background: linear-gradient(135deg, rgba(26, 31, 58, 1) 0%, rgba(30, 36, 66, 1) 100%);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), 0 0 0 1px rgba(244, 196, 48, 0.08);
        }

        .asset-row-main {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .asset-row-icon {
            font-size: 1.5rem;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            background: rgba(255,255,255,0.04);
            flex-shrink: 0;
        }

        .asset-row-info {
            flex: 1;
            min-width: 0;
        }

        .asset-row-name {
            font-size: 0.95rem;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .asset-row-provider {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .asset-row-values {
            text-align: left;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .asset-row-amount {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--accent-gold);
            white-space: nowrap;
        }

        .asset-row-sub {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 2px;
        }

        .asset-row-return {
            font-size: 0.8rem;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 20px;
            white-space: nowrap;
            flex-shrink: 0;
            margin-right: 4px;
        }

        .asset-row-return.positive {
            color: var(--accent-green);
            background: rgba(16, 185, 129, 0.1);
        }

        .asset-row-return.negative {
            color: var(--accent-red);
            background: rgba(239, 68, 68, 0.1);
        }

        .asset-row-expand {
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.35s ease, padding 0.35s ease, opacity 0.25s ease;
            opacity: 0;
        }

        .asset-row-expand.open {
            max-height: 500px;
            opacity: 1;
            padding-top: 14px;
            margin-top: 14px;
            border-top: 1px solid var(--border-color);
        }

        .asset-row-edit-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 18px;
            background: linear-gradient(135deg, var(--accent-gold) 0%, #ffd700 100%);
            color: #0a0e27;
            border: none;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s ease;
            margin-top: 12px;
        }

        .asset-row-edit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(244, 196, 48, 0.3);
        }

        .asset-row-chevron {
            transition: transform 0.3s ease;
            font-size: 0.7rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .asset-row.expanded .asset-row-chevron {
            transform: rotate(180deg);
        }

        .asset-row-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 10px;
        }

        .asset-row-detail {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .asset-row-detail-label {
            font-size: 0.7rem;
            color: var(--text-secondary);
        }

        .asset-row-detail-value {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .asset-row.spy-row {
            border: 1px solid rgba(244, 196, 48, 0.3);
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(40, 35, 20, 0.5) 100%);
        }

        .spy-daily-bar {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 10px;
            padding: 10px 14px;
            background: rgba(244,196,48,0.06);
            border-radius: 10px;
            border: 1px solid rgba(244,196,48,0.12);
        }

        .spy-daily-item {
            display: flex;
            flex-direction: column;
            gap: 1px;
        }

        .spy-daily-label {
            font-size: 0.65rem;
            color: var(--text-secondary);
        }

        .spy-daily-value {
            font-size: 0.8rem;
            font-weight: 700;
        }

        /* ============ iPhone & Mobile Optimization ============ */
        /* ============ IPHONE ACTIVE STATES ============ */
        .asset-row:active {
            transform: scale(0.98);
            opacity: 0.85;
            transition: all 0.1s ease;
        }
        .quick-action-btn:active {
            transform: scale(0.95);
            opacity: 0.8;
        }
        .stat-card:active {
            transform: scale(0.97);
        }
        .action-button:active, .secondary-button:active {
            transform: scale(0.96);
            opacity: 0.85;
        }

        /* ============ IPHONE STANDARD (430px) ============ */
        @media (max-width: 430px) {
            body {
                padding: 14px;
                padding-top: calc(14px + env(safe-area-inset-top, 0px));
                padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px));
            }

            /* Header */
            .header { margin-bottom: 16px; }
            .header-top { 
                margin-bottom: 12px; 
                flex-wrap: wrap; 
                gap: 10px; 
            }
            .header h1 { font-size: 1.5rem; letter-spacing: -0.5px; }
            .header-top .action-button { 
                padding: 12px 18px; 
                font-size: 0.85rem;
                border-radius: 12px;
                min-height: 44px;
            }
            .last-update { font-size: 0.72rem; }
            .last-update > span[style*="gap: 15px"],
            .last-update span[style*="gap: 15px"] { 
                gap: 8px !important; 
                font-size: 0.7rem; 
            }

            /* Total Worth Card */
            .total-worth-card { 
                padding: 22px 16px; 
                border-radius: 18px; 
            }
            .total-label { 
                font-size: 0.8rem; 
                margin-bottom: 6px;
                letter-spacing: 1.5px;
            }
            .total-amount { 
                font-size: 2.5rem; 
                margin-bottom: 10px; 
            }
            .total-change { font-size: 0.78rem; gap: 6px; }

            /* Breakdown */
            #totalBreakdown {
                gap: 6px !important;
                margin-top: 14px !important;
                padding-top: 14px !important;
                flex-direction: row !important;
                justify-content: space-between !important;
            }
            #totalBreakdown > div:not([style*="width:1px"]) {
                min-width: 0 !important;
                flex: 1;
            }
            #totalBreakdown > div[style*="width:1px"] {
                display: none !important;
            }
            #totalLiquid, #totalPension, #totalRealEstate {
                font-size: 0.92rem !important;
            }
            #totalBreakdown .asset-row-detail-label,
            #totalBreakdown div[style*="font-size:0.7rem"] {
                font-size: 0.65rem !important;
            }

            /* Quick Actions - smooth horizontal scroll */
            .quick-actions {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
                scrollbar-width: none;
                gap: 8px;
                margin-bottom: 16px;
                padding-bottom: 2px;
                margin-left: -14px;
                margin-right: -14px;
                padding-left: 14px;
                padding-right: 14px;
                scroll-snap-type: x proximity;
            }
            .quick-actions::-webkit-scrollbar { display: none; }
            .quick-action-btn {
                min-width: auto;
                white-space: nowrap;
                padding: 10px 14px;
                font-size: 0.78rem;
                gap: 6px;
                border-radius: 12px;
                flex-shrink: 0;
                flex: none;
                min-height: 44px;
                scroll-snap-align: start;
            }
            .quick-action-btn .btn-icon { font-size: 1rem; }

            /* Category Stats */
            .stats-bar {
                gap: 8px;
                margin-bottom: 16px;
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            }
            .stat-card {
                padding: 14px 12px;
                border-radius: 10px;
            }
            .stat-card:hover {
                transform: none;
                box-shadow: none;
            }
            .stat-icon { font-size: 1.4rem; margin-bottom: 6px; }
            .stat-label { font-size: 0.65rem; margin-bottom: 6px; letter-spacing: 0.5px; }
            .stat-value { font-size: 1.2rem; }
            .stat-change { font-size: 0.7rem; }

            /* Sort buttons */
            .sort-btn {
                font-size: 0.7rem !important;
                padding: 6px 12px !important;
                min-height: 36px !important;
                border-radius: 8px !important;
            }

            /* Section titles */
            .section-title {
                font-size: 1.2rem;
                margin-bottom: 14px;
                gap: 10px;
            }
            .section-title::before {
                width: 3px;
                height: 20px;
            }

            /* Asset Rows */
            .asset-row { 
                padding: 14px; 
                border-radius: 14px;
                gap: 6px;
            }
            .asset-row-main { gap: 12px; }
            .asset-row-icon { 
                width: 40px; 
                height: 40px; 
                font-size: 1.2rem;
                border-radius: 12px;
            }
            .asset-row-name { font-size: 0.88rem; }
            .asset-row-provider { font-size: 0.7rem; }
            .asset-row-amount { font-size: 1.05rem; }
            .asset-row-sub { font-size: 0.65rem; }
            .asset-row-return { 
                font-size: 0.72rem; 
                padding: 4px 10px;
                border-radius: 16px;
                margin-right: 2px;
            }
            .asset-row-details { 
                grid-template-columns: 1fr 1fr; 
                gap: 10px;
            }
            .asset-row-detail-label { font-size: 0.65rem; }
            .asset-row-detail-value { font-size: 0.82rem; }
            .asset-row:hover {
                transform: none;
                box-shadow: none;
            }
            .asset-row-chevron { font-size: 0.6rem; }
            .asset-row-edit-btn {
                padding: 10px 16px;
                font-size: 0.8rem;
                min-height: 44px;
                width: 100%;
                justify-content: center;
                border-radius: 10px;
            }

            /* SPY daily bar */
            .spy-daily-bar { 
                gap: 14px; 
                padding: 10px 12px;
                border-radius: 10px;
            }
            .spy-daily-label { font-size: 0.62rem; }
            .spy-daily-value { font-size: 0.75rem; }

            /* Allocation section */
            .allocation-grid { gap: 16px; }
            .chart-card { padding: 16px; border-radius: 14px; }
            .chart-container { height: 240px; }

            /* Modal - fullscreen on iPhone */
            .modal-content { 
                width: 100%;
                max-width: 100%;
                max-height: 100%;
                height: 100%;
                border-radius: 0;
                padding: 16px;
                padding-top: calc(16px + env(safe-area-inset-top, 0px));
                padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
            }
            .modal-header { margin-bottom: 20px; }
            .modal-header h2 { font-size: 1.3rem; }
            .form-group { margin-bottom: 16px; }
            .form-group label { font-size: 0.82rem; margin-bottom: 6px; }
            .form-group input,
            .form-group select {
                font-size: 16px !important; /* Prevent iOS zoom */
                padding: 14px;
                border-radius: 12px;
                min-height: 48px;
            }
            .button-group { 
                flex-wrap: wrap; 
                gap: 10px;
                margin-top: 24px;
            }
            .button-group .action-button,
            .button-group .secondary-button { 
                padding: 16px;
                font-size: 0.92rem;
                min-height: 50px;
                border-radius: 12px;
            }

            /* Insights */
            .insight-card { padding: 14px; border-radius: 10px; }
            .insight-icon { font-size: 1.4rem !important; }
            .insight-title { font-size: 0.85rem !important; }
            .insight-text { font-size: 0.75rem !important; }

            /* History chart */
            #historySection canvas { border-radius: 12px; }
        }

        /* ============ IPHONE SE / Mini (375px) ============ */
        @media (max-width: 375px) {
            body { padding: 10px; padding-top: calc(10px + env(safe-area-inset-top, 0px)); padding-bottom: calc(70px + env(safe-area-inset-bottom, 0px)); }
            .header h1 { font-size: 1.3rem; }
            .total-amount { font-size: 2.1rem; }
            .total-worth-card { padding: 18px 12px; }
            #totalLiquid, #totalPension, #totalRealEstate { font-size: 0.82rem !important; }
            .asset-row { padding: 12px; }
            .asset-row-icon { width: 36px; height: 36px; font-size: 1.1rem; }
            .asset-row-name { font-size: 0.82rem; }
            .asset-row-amount { font-size: 0.95rem; }
            .asset-row-return { font-size: 0.65rem; padding: 3px 8px; }
            .stats-bar { grid-template-columns: 1fr 1fr; gap: 6px; }
            .stat-card { padding: 10px 8px; }
            .stat-value { font-size: 1rem; }
            .stat-label { font-size: 0.6rem; }
            .stat-icon { font-size: 1.2rem; margin-bottom: 4px; }
            .quick-action-btn { padding: 8px 12px; font-size: 0.75rem; }
        }

        /* ============ IPHONE PRO MAX (428-430px) ============ */
        @media (min-width: 410px) and (max-width: 430px) {
            .total-amount { font-size: 2.8rem; }
            .asset-row-amount { font-size: 1.1rem; }
            .stat-value { font-size: 1.35rem; }
        }

        /* ============ IPHONE LANDSCAPE ============ */
        @media (max-height: 450px) and (orientation: landscape) {
            body { padding: 10px; padding-left: calc(10px + env(safe-area-inset-left, 0px)); padding-right: calc(10px + env(safe-area-inset-right, 0px)); }
            .total-worth-card { padding: 14px; }
            .total-amount { font-size: 1.8rem; margin-bottom: 6px; }
            .total-worth-card::before { display: none; }
            #totalBreakdown { margin-top: 8px !important; padding-top: 8px !important; }
            .asset-row { padding: 10px 14px; }
        }

        /* ============ PWA STANDALONE MODE ============ */
        @media all and (display-mode: standalone) {
            body {
                padding-top: calc(20px + env(safe-area-inset-top, 0px));
                /* Extra bottom padding for home indicator */
                padding-bottom: calc(30px + env(safe-area-inset-bottom, 0px));
            }
            /* Disable text selection on interactive elements */
            .asset-row, .quick-action-btn, .stat-card, .action-button, .secondary-button, .sort-btn {
                -webkit-user-select: none;
                user-select: none;
                -webkit-touch-callout: none;
            }
        }

        .allocation-section {
            margin-bottom: 40px;
            animation: fadeInUp 0.8s ease-out 0.3s both;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 25px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .section-title::before {
            content: '';
            width: 4px;
            height: 30px;
            background: var(--accent-gold);
            border-radius: 2px;
        }

        .allocation-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 25px;
        }

        @media (max-width: 968px) {
            .allocation-grid {
                grid-template-columns: 1fr;
            }
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 30px;
        }

        .chart-container {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        .donut-chart {
            width: 250px;
            height: 250px;
            position: relative;
        }

        .donut-segment {
            transition: all 0.3s ease;
        }

        .donut-segment:hover {
            opacity: 0.8;
            transform: scale(1.05);
        }

        .chart-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .chart-center-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-gold);
        }

        .chart-center-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .legend {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .legend-item:hover {
            background: var(--bg-hover);
            transform: translateX(-5px);
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        .legend-label {
            flex: 1;
            font-size: 0.95rem;
        }

        .legend-value {
            font-weight: 600;
            color: var(--accent-gold);
        }

        .legend-percent {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .action-button {
            background: linear-gradient(135deg, var(--accent-gold) 0%, #ffd700 100%);
            color: var(--bg-primary);
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Rubik', sans-serif;
        }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(244, 196, 48, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .modal-title {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .close-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 2rem;
            cursor: pointer;
            transition: color 0.3s ease;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .close-button:hover {
            color: var(--text-primary);
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'Rubik', sans-serif;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--accent-gold);
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .secondary-button {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Rubik', sans-serif;
            flex: 1;
        }

        .secondary-button:hover {
            background: var(--bg-hover);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
            animation: fadeInUp 0.8s ease-out 0.2s both;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--bg-card) 0%, rgba(26, 31, 58, 0.8) 100%);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-gold), #b026ff);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            border-color: var(--accent-gold);
            box-shadow: 0 10px 30px rgba(0, 255, 136, 0.3);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .stat-change {
            font-size: 0.8rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .stat-change.positive {
            color: var(--accent-green);
        }

        .stat-change.negative {
            color: var(--accent-red);
        }

        .insights-section {
            margin-bottom: 40px;
            animation: fadeInUp 0.8s ease-out 0.4s both;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .insight-card {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(176, 38, 255, 0.1) 100%);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }

        .insight-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 255, 136, 0.15) 0%, transparent 70%);
            animation: rotateInsight 15s linear infinite;
        }

        @keyframes rotateInsight {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .insight-content {
            position: relative;
            z-index: 1;
        }

        .insight-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }

        .insight-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--accent-green);
        }

        .insight-text {
            font-size: 0.95rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .quick-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            animation: fadeInUp 0.8s ease-out 0.3s both;
        }

        .quick-action-btn {
            flex: 1;
            min-width: 150px;
            padding: 15px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Rubik', sans-serif;
        }

        .quick-action-btn:hover {
            background: var(--bg-hover);
            border-color: var(--accent-gold);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 136, 0.2);
        }

        .progress-ring {
            width: 120px;
            height: 120px;
            margin: 0 auto;
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.5s ease;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .mini-chart {
            height: 60px;
            margin-top: 15px;
            display: flex;
            align-items: flex-end;
            gap: 3px;
            justify-content: center;
        }

        .mini-chart-bar {
            flex: 1;
            background: linear-gradient(to top, var(--accent-gold), #b026ff);
            border-radius: 3px 3px 0 0;
            transition: all 0.3s ease;
            opacity: 0.6;
        }

        .mini-chart-bar:hover {
            opacity: 1;
            transform: scaleY(1.1);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .live-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--accent-green);
            border-radius: 50%;
            animation: pulse 2s ease-in-out infinite;
            margin-left: 8px;
        }

        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-gold);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>ğŸ“Š ×œ×•×— ×”×‘×§×¨×” ×”×¤×™× × ×¡×™ ×©×œ×™</h1>
                <div>
                    <button class="action-button" onclick="openModal('add')">â• ×”×•×¡×£ × ×›×¡</button>
                </div>
            </div>
            <div class="last-update">
                ×¢×“×›×•×Ÿ ××—×¨×•×Ÿ: <span id="lastUpdate">--</span>
                <span style="margin: 0 10px;">â€¢</span>
                <span style="cursor: pointer; display: inline-flex; align-items: center; gap: 5px;" onclick="updateExchangeRate()" title="×œ×—×¥ ×œ×¢×“×›×•×Ÿ ×©×¢×¨×™×">
                    <span id="rateUpdateIndicator" style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background: #10b981;"></span>
                    <span style="display: inline-flex; gap: 15px; flex-wrap: wrap;">
                        <span>$1 = â‚ª<span id="exchangeRateDisplay">3.7</span> <span id="ilsDailyChange" style="font-size:0.75em;"></span></span>
                        <span>â‚¿1 = $<span id="btcRateDisplay">100,000</span></span>
                        <span>Î1 = $<span id="ethRateDisplay">3,500</span></span>
                    </span>
                </span>
            </div>
        </div>

        <div class="total-worth-card">
            <div class="total-worth-content">
                <div class="total-label">×¡×š ×›×œ ×”× ×›×¡×™×</div>
                <div class="total-amount" id="totalWorth">â‚ª0</div>
                <div class="total-change positive" id="totalChange">
                    <span>â–²</span>
                    <span>+â‚ª0 (0%)</span>
                    <span>×”×—×•×“×©</span>
                </div>
                <div id="totalBreakdown" style="display:flex;justify-content:center;gap:20px;flex-wrap:wrap;margin-top:20px;padding-top:20px;border-top:1px solid rgba(255,255,255,0.1);">
                    <div style="text-align:center;min-width:100px;">
                        <div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:4px;">ğŸ’° × ×–×™×œ×™×</div>
                        <div id="totalLiquid" style="font-size:1.1rem;font-weight:600;color:#00d9ff;">â‚ª0</div>
                    </div>
                    <div style="width:1px;background:rgba(255,255,255,0.1);"></div>
                    <div style="text-align:center;min-width:100px;">
                        <div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:4px;">ğŸ¦ ×¤× ×¡×™×” ×•×’××œ</div>
                        <div id="totalPension" style="font-size:1.1rem;font-weight:600;color:#b026ff;">â‚ª0</div>
                    </div>
                    <div style="width:1px;background:rgba(255,255,255,0.1);"></div>
                    <div style="text-align:center;min-width:100px;">
                        <div style="font-size:0.7rem;color:var(--text-secondary);margin-bottom:4px;">ğŸ  × ×“×œ"×Ÿ</div>
                        <div id="totalRealEstate" style="font-size:1.1rem;font-weight:600;color:#10b981;">â‚ª0</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="stats-bar" id="categoryStats">
            <!-- Dynamic category cards generated by JS -->
        </div>

        <div class="quick-actions">
            <button class="quick-action-btn" onclick="openModal('add')">
                <span>â•</span>
                <span>×”×•×¡×£ × ×›×¡</span>
            </button>
            <button class="quick-action-btn" onclick="updateExchangeRate()">
                <span>ğŸ”„</span>
                <span>×¢×“×›×Ÿ ×©×¢×¨×™×</span>
                <span class="live-indicator"></span>
            </button>
            <button class="quick-action-btn" onclick="refreshSpy()" id="spyRefreshBtn" style="display: none; border: 2px solid var(--accent-gold);">
                <span>ğŸ“ˆ</span>
                <span>×¢×“×›×Ÿ SPY</span>
                <span id="spyStatus" style="font-size: 0.7rem; color: var(--accent-green);"></span>
            </button>
            <button class="quick-action-btn" onclick="showDataMenu()">
                <span>ğŸ’¾</span>
                <span>×™×™×¦×•×/×™×™×‘×•×</span>
            </button>
            <button class="quick-action-btn" onclick="showInsights()">
                <span>ğŸ’¡</span>
                <span>×ª×•×‘× ×•×ª</span>
            </button>
        </div>

        <div class="insights-section" id="insightsSection" style="display: none;">
            <div class="section-title">ğŸ’¡ ×ª×•×‘× ×•×ª ×•×”××œ×¦×•×ª</div>
            <div class="insights-grid" id="insightsGrid"></div>
        </div>

        <!-- History Chart -->
        <div class="allocation-section" id="historySection" style="display:none;">
            <div class="section-title">ğŸ“ˆ ××’××ª ×©×•×•×™ ×œ××•×¨×š ×–××Ÿ</div>
            <div class="chart-card" style="padding:20px;">
                <canvas id="historyChart" style="width:100%;height:180px;"></canvas>
                <div id="historyEmpty" style="text-align:center;color:var(--text-secondary);padding:30px;display:none;">
                    ğŸ“Š × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™× ×™×ª×—×™×œ×• ×œ×”×¦×˜×‘×¨ ××”×™×•×. ×—×–×•×¨ ××—×¨!
                </div>
            </div>
        </div>

        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;margin-bottom:10px;">
            <div class="section-title" style="margin-bottom:0;">×”× ×›×¡×™× ×©×œ×™</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
                <button onclick="sortAssets('value')" class="sort-btn active-sort" style="padding:5px 12px;border-radius:20px;border:1px solid var(--border-color);background:rgba(244,196,48,0.15);color:var(--accent-gold);font-size:0.75rem;cursor:pointer;font-family:inherit;">×©×•×•×™ â†“</button>
                <button onclick="sortAssets('type')" class="sort-btn" style="padding:5px 12px;border-radius:20px;border:1px solid var(--border-color);background:transparent;color:var(--text-secondary);font-size:0.75rem;cursor:pointer;font-family:inherit;">×¡×•×’</button>
                <button onclick="sortAssets('return')" class="sort-btn" style="padding:5px 12px;border-radius:20px;border:1px solid var(--border-color);background:transparent;color:var(--text-secondary);font-size:0.75rem;cursor:pointer;font-family:inherit;">×ª×©×•××” â†“</button>
                <button onclick="sortAssets('name')" class="sort-btn" style="padding:5px 12px;border-radius:20px;border:1px solid var(--border-color);background:transparent;color:var(--text-secondary);font-size:0.75rem;cursor:pointer;font-family:inherit;">×©×</button>
            </div>
        </div>
        <div class="assets-grid" id="assetsGrid">
            <!-- Assets will be dynamically added here -->
        </div>

        <div class="allocation-section">
            <div class="section-title">×”×ª×¤×œ×’×•×ª × ×›×¡×™×</div>
            <div class="allocation-grid">
                <div class="chart-card">
                    <h3 style="margin-bottom: 20px;">×—×œ×•×§×” ×œ×¤×™ ×¡×•×’</h3>
                    <div class="chart-container">
                        <svg class="donut-chart" id="donutChart" viewBox="0 0 100 100"></svg>
                        <div class="chart-center">
                            <div class="chart-center-value" id="chartTotal">100%</div>
                            <div class="chart-center-label">×¡×”"×› × ×›×¡×™×</div>
                        </div>
                    </div>
                </div>
                <div class="chart-card">
                    <h3 style="margin-bottom: 20px;">×¤×™×¨×•×˜</h3>
                    <div class="legend" id="legend">
                        <!-- Legend items will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal" id="assetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">×”×•×¡×£ × ×›×¡ ×—×“×©</h2>
                <button class="close-button" onclick="closeModal()">Ã—</button>
            </div>
            <form id="assetForm">
                <div class="form-group">
                    <label>×¡×•×’ ×”× ×›×¡</label>
                    <select id="assetType" required onchange="toggleRealEstateFields()">
                        <option value="">×‘×—×¨ ×¡×•×’ × ×›×¡</option>
                        <option value="pension">×¤× ×¡×™×”</option>
                        <option value="gemel">×’××œ</option>
                        <option value="fund">×§×¨×Ÿ ×”×©×ª×œ××•×ª</option>
                        <option value="savings">×§×¨×Ÿ ×›×¡×¤×™×ª / ×—×™×¡×›×•×Ÿ</option>
                        <option value="trade">×˜×¨×™×™×“ / ×× ×™×•×ª</option>
                        <option value="crypto">×§×¨×™×¤×˜×•</option>
                        <option value="real_estate">× ×“×œ"×Ÿ / ×“×™×¨×”</option>
                        <option value="other">××—×¨</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>×©× ×”× ×›×¡</label>
                    <input type="text" id="assetName" placeholder="×œ×“×•×’××”: ×¤× ×¡×™×” ××§×™×¤×”" required>
                </div>
                <div class="form-group">
                    <label>×¡×¤×§ / ×—×‘×¨×”</label>
                    <input type="text" id="assetProvider" placeholder="×œ×“×•×’××”: ××’×“×œ, ×œ××•××™, ×‘×™×˜×•×— ×™×©×™×¨" required>
                </div>
                
                <!-- Real Estate specific fields -->
                <div id="realEstateFields" style="display: none;">
                    <div class="form-group">
                        <label>×©×•×•×™ ×”×“×™×¨×” (â‚ª)</label>
                        <input type="text" inputmode="decimal" id="propertyValue" placeholder="0" oninput="formatNumberInput(this); calculateEquity()">
                    </div>
                    <div class="form-group">
                        <label>××©×›× ×ª× / ×—×•×‘ (â‚ª)</label>
                        <input type="text" inputmode="decimal" id="mortgage" placeholder="0" oninput="formatNumberInput(this); calculateEquity()">
                    </div>
                    <div style="padding: 15px; background: #f7fafc; border-radius: 10px; margin-bottom: 20px;">
                        <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 5px;">×”×•×Ÿ ×¢×¦××™ ××—×•×©×‘:</div>
                        <div style="font-size: 1.3rem; font-weight: 600; color: var(--accent-gold);" id="calculatedEquity">â‚ª0</div>
                    </div>
                </div>

                <!-- SPY Pension specific fields -->
                <div id="spyPensionCheckbox" style="display: none; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="isSpyPension" onchange="toggleSpyFields()" style="width: 20px; height: 20px; cursor: pointer;">
                        <span style="font-weight: 600;">×¤× ×¡×™×” ××•×©×§×¢×ª ×‘××“×“ S&P 500 (SPY)</span>
                    </label>
                </div>

                <div id="spyFields" style="display: none;">
                    <!-- Hidden fields for units and avg price - always present -->
                    <input type="hidden" id="spyUnits" value="0">
                    <input type="hidden" id="spyAvgPrice" value="0">
                    
                    <div style="padding: 15px; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1)); border: 2px solid var(--accent-gold); border-radius: 12px; margin-bottom: 20px;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: var(--accent-gold); margin-bottom: 15px; display: flex; align-items: center; gap: 8px;">
                            ğŸ“ˆ ××¢×§×‘ ××—×¨ SPY ×‘×–××Ÿ ×××ª
                        </div>
                        
                        <!-- Input mode selection -->
                        <div style="margin-bottom: 20px; display: flex; gap: 15px; padding: 12px; background: rgba(0,0,0,0.2); border-radius: 8px;">
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1;">
                                <input type="radio" name="spyInputMode" value="ils" checked onchange="toggleSpyInputMode()" style="cursor: pointer;">
                                <span style="font-size: 0.9rem; font-weight: 600;">×”×–×Ÿ ×¡×›×•× ×‘×©×§×œ×™×</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer; flex: 1;">
                                <input type="radio" name="spyInputMode" value="units" onchange="toggleSpyInputMode()" style="cursor: pointer;">
                                <span style="font-size: 0.9rem;">×™×© ×œ×™ ×™×—×™×“×•×ª SPY</span>
                            </label>
                        </div>

                        <!-- ILS input mode -->
                        <div id="spyIlsMode">
                            <div class="form-group">
                                <label>×¡×›×•× × ×•×›×—×™ ×‘×¤× ×¡×™×” (â‚ª)</label>
                                <input type="text" inputmode="decimal" id="spyAmountILS" placeholder="×œ×“×•×’××”: 370,000" oninput="formatNumberInput(this); calculateFromILS()">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                                    ğŸ’¡ ×”×–×Ÿ ××ª ×”×¡×›×•× ×©××ª×” ×¨×•××” ×‘××¢×¨×›×ª ×©×œ ××’×“×œ
                                </div>
                            </div>
                            <div class="form-group">
                                <label>××—×™×¨ ×¨×›×™×©×” ×××•×¦×¢ ($) - ××•×¤×¦×™×•× ×œ×™</label>
                                <input type="text" inputmode="decimal" id="spyAvgPriceILS" placeholder="×œ×“×•×’××”: 350" oninput="formatNumberInput(this); calculateFromILS()">
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;">
                                    ğŸ’¡ ×‘××™×–×” ××—×™×¨ ×××•×¦×¢ × ×›× ×¡×ª? (×× ×œ× ×™×•×“×¢ - ×”×©××¨ ×¨×™×§)
                                </div>
                            </div>
                        </div>

                        <!-- Units input mode -->
                        <div id="spyUnitsMode" style="display: none;">
                            <div class="form-group">
                                <label>×›××•×ª ×™×—×™×“×•×ª SPY</label>
                                <input type="text" inputmode="decimal" id="spyUnitsDisplay" placeholder="0" oninput="formatNumberInput(this); calculateSpyValue()">
                            </div>
                            <div class="form-group">
                                <label>××—×™×¨ ×¨×›×™×©×” ×××•×¦×¢ ($)</label>
                                <input type="text" inputmode="decimal" id="spyAvgPriceDisplay" placeholder="0" oninput="formatNumberInput(this); calculateSpyValue()">
                            </div>
                        </div>

                        <!-- Common display section -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 8px; margin-top: 15px;">
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 5px;">××—×™×¨ SPY × ×•×›×—×™:</div>
                                <div style="font-size: 1.1rem; font-weight: 700; color: var(--accent-green); cursor: pointer;" id="currentSpyPrice" onclick="manualSpyEntry()" title="×œ×—×¥ ×œ×”×–× ×” ×™×“× ×™×ª">$--</div>
                            </div>
                            <div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 5px;">×ª×©×•××”:</div>
                                <div style="font-size: 1.1rem; font-weight: 700;" id="spyReturn">--%</div>
                            </div>
                        </div>
                        <div id="spyCalculatedDisplay" style="padding: 12px; background: rgba(244, 196, 48, 0.1); border-radius: 8px; margin-top: 12px;">
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 5px;">×™×—×™×“×•×ª ××—×•×©×‘×•×ª:</div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: var(--accent-blue); margin-bottom: 10px;" id="calculatedUnitsFromILS">0.000</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-bottom: 5px;">×©×•×•×™ ×›×•×œ×œ:</div>
                            <div style="font-size: 1.4rem; font-weight: 700; color: var(--accent-gold);" id="calculatedSpyValue">â‚ª0</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 5px;" id="calculatedSpyValueUSD">$0</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group" id="currencyField">
                    <label>××˜×‘×¢</label>
                    <select id="assetCurrency" required>
                        <option value="ILS">×©×§×œ×™× (â‚ª)</option>
                        <option value="USD">×“×•×œ×¨×™× ($)</option>
                        <option value="BTC">×‘×™×˜×§×•×™×Ÿ (â‚¿)</option>
                        <option value="ETH">××™×ª×¨×™×•× (Î)</option>
                    </select>
                </div>
                <div class="form-group" id="valueField">
                    <label>×©×•×•×™ × ×•×›×—×™</label>
                    <input type="text" inputmode="decimal" id="assetValue" placeholder="0" oninput="formatNumberInput(this)">
                </div>
                <div class="form-group">
                    <label>×ª×©×•××” ×©× ×ª×™×ª (%)</label>
                    <input type="text" inputmode="decimal" id="assetReturn" placeholder="0" oninput="formatNumberInput(this)">
                </div>
                <div class="form-group">
                    <label>×”×¤×§×“×” ×—×•×“×©×™×ª (â‚ª)</label>
                    <input type="text" inputmode="decimal" id="assetMonthly" placeholder="0" oninput="formatNumberInput(this)">
                </div>
                <div class="button-group">
                    <button type="button" class="secondary-button" onclick="closeModal()">×‘×™×˜×•×œ</button>
                    <button type="button" id="deleteAssetBtn" class="secondary-button" style="display:none; background:rgba(239,68,68,0.15); color:var(--accent-red,#ef4444); border-color:var(--accent-red,#ef4444);" onclick="deleteCurrentAsset()">ğŸ—‘ï¸ ××—×§</button>
                    <button type="submit" class="action-button" style="flex: 1;">×©××•×¨</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let assets = [];
        let editingAssetId = null;
        let exchangeRate = 3.7; // USD to ILS exchange rate
        let exchangeRatePrevClose = 0; // Previous close for daily change
        let btcRate = 100000; // BTC to USD
        let ethRate = 3500; // ETH to USD
        let spyPrice = 0; // SPY current price
        let spyPrevClose = 0; // SPY previous close
        let spyDailyChangePct = 0; // SPY daily change %
        let lastRateUpdate = null;
        let lastSpyUpdate = null;
        const FINNHUB_DEFAULT_KEY = 'd69gf19r01qjmno57nngd69gf19r01qjmno57no0';

        // ============ Number Formatting Helpers ============
        // Parse a number string that may contain commas
        function parseNum(el) {
            if (!el) return 0;
            var val = (typeof el === 'string') ? el : (el.value || '');
            // Remove spaces and thousands separators
            val = val.replace(/\s/g, '').replace(/,/g, '');
            var num = parseFloat(val);
            return isNaN(num) ? 0 : num;
        }

        // Format input field with thousands separators as user types
        function formatNumberInput(input) {
            var cursorPos = input.selectionStart;
            var oldLen = input.value.length;
            
            // Strip everything except digits, dots, commas (as decimal), and minus
            var raw = input.value.replace(/[^\d.\-,]/g, '');
            
            // In Hebrew locale, comma might be used as decimal - convert to dot
            // But only if there's exactly one comma and no dots
            var commaCount = (raw.match(/,/g) || []).length;
            var dotCount = (raw.match(/\./g) || []).length;
            if (commaCount === 1 && dotCount === 0 && raw.indexOf(',') > 0) {
                // Check if it looks like a decimal (less than 3 digits after comma)
                var afterComma = raw.split(',')[1] || '';
                if (afterComma.length <= 2) {
                    // This is probably a decimal comma (e.g. 117043,55)
                    raw = raw.replace(',', '.');
                }
            }
            
            // Now remove all commas (thousands separators)
            raw = raw.replace(/,/g, '');
            
            // Split by decimal point
            var parts = raw.split('.');
            var intPart = parts[0] || '';
            var decPart = parts.length > 1 ? parts.slice(1).join('') : null;
            
            // Add thousands separators
            var negative = intPart.startsWith('-');
            if (negative) intPart = intPart.substring(1);
            intPart = intPart.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            if (negative) intPart = '-' + intPart;
            
            var formatted = decPart !== null ? intPart + '.' + decPart : intPart;
            
            if (formatted !== input.value) {
                input.value = formatted;
                // Adjust cursor position
                var newLen = formatted.length;
                var diff = newLen - oldLen;
                var newPos = cursorPos + diff;
                if (newPos < 0) newPos = 0;
                input.setSelectionRange(newPos, newPos);
            }
        }

        // Format a number for display in a text input (with commas)
        function formatNum(num) {
            if (!num && num !== 0) return '';
            var n = parseFloat(num);
            if (isNaN(n)) return '';
            if (n === 0) return '0';
            // Up to 2 decimal places, with commas
            var fixed = n % 1 === 0 ? n.toString() : n.toFixed(2).replace(/\.?0+$/, '');
            var parts = fixed.split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }

        // ============ SPY PRICE SYSTEM ============
        // Tested & working: Finnhub /quote, Yahoo via corsproxy.io

        function getFinnhubKey() {
            return localStorage.getItem('finnhub-api-key') || FINNHUB_DEFAULT_KEY;
        }

        async function fetchSpyPrice() {
            console.log('[SPY] fetchSpyPrice called');
            let lastError = '';

            // === Source 1: Finnhub /quote ===
            try {
                const key = getFinnhubKey();
                const url = `https://finnhub.io/api/v1/quote?symbol=SPY&token=${key}`;
                console.log('[SPY] Trying Finnhub...');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 12000);
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                console.log('[SPY] Finnhub HTTP', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('[SPY] Finnhub data:', JSON.stringify(data));
                    const price = (data && data.c > 0) ? data.c : (data && data.pc > 0 ? data.pc : 0);
                    if (price > 0) {
                        console.log('[SPY] âœ… Finnhub price:', price);
                        // Store daily change data
                        if (data.pc > 0) {
                            spyPrevClose = data.pc;
                            spyDailyChangePct = data.dp || ((price - data.pc) / data.pc * 100);
                            try {
                                localStorage.setItem('spy-prev-close', spyPrevClose.toString());
                                localStorage.setItem('spy-daily-change', spyDailyChangePct.toString());
                            } catch(e) {}
                        }
                        return applySpyPrice(price);
                    }
                }
                lastError = 'Finnhub: no valid price';
            } catch (e) {
                lastError = 'Finnhub: ' + e.message;
                console.warn('[SPY] Finnhub failed:', e.message);
            }

            // === Source 2: Yahoo via corsproxy.io ===
            try {
                const url = 'https://corsproxy.io/?' + encodeURIComponent('https://query1.finance.yahoo.com/v8/finance/chart/SPY');
                console.log('[SPY] Trying Yahoo via corsproxy...');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 12000);
                const response = await fetch(url, { signal: controller.signal });
                clearTimeout(timeoutId);
                console.log('[SPY] corsproxy HTTP', response.status);
                if (response.ok) {
                    const data = await response.json();
                    const meta = data && data.chart && data.chart.result && data.chart.result[0] && data.chart.result[0].meta;
                    const price = meta ? (meta.regularMarketPrice || meta.previousClose) : 0;
                    if (price > 0) {
                        console.log('[SPY] âœ… corsproxy price:', price);
                        return applySpyPrice(price);
                    }
                }
                lastError += ' | corsproxy: no valid price';
            } catch (e) {
                lastError += ' | corsproxy: ' + e.message;
                console.warn('[SPY] corsproxy failed:', e.message);
            }

            console.error('[SPY] âŒ All sources failed:', lastError);
            return spyPrice > 0;
        }

        // Apply new SPY price and update everything
        function applySpyPrice(price) {
            spyPrice = price;
            lastSpyUpdate = new Date().toISOString();
            try {
                localStorage.setItem('spy-price', spyPrice.toString());
                localStorage.setItem('spy-price-date', lastSpyUpdate);
            } catch (e) {}
            console.log('[SPY] Applied price: $' + spyPrice.toFixed(2));
            updateSpyAssets();
            // Update modal if open
            var sf = document.getElementById('spyFields');
            if (sf && sf.style.display === 'block') {
                var mr = document.querySelector('input[name="spyInputMode"]:checked');
                if (mr) {
                    if (mr.value === 'ils') calculateFromILS();
                    else calculateSpyValue();
                }
            }
            updateUI();
            return true;
        }

        // Manual SPY price entry
        function manualSpyEntry() {
            const current = spyPrice > 0 ? spyPrice.toFixed(2) : '';
            const input = prompt(`×”×–×Ÿ ××—×™×¨ SPY × ×•×›×—×™ ×‘×“×•×œ×¨×™×:\n\nğŸ’¡ ×—×¤×© ×‘×’×•×’×œ: "SPY stock price"\nğŸ“± ××•: finance.yahoo.com/quote/SPY\n\n` + (current ? `××—×™×¨ ×©××•×¨: $${current}` : '××™×Ÿ ××—×™×¨ ×©××•×¨'), current);
            if (input !== null) {
                const price = parseFloat(input);
                if (price > 0 && price < 10000) {
                    spyPrice = price;
                    lastSpyUpdate = new Date().toISOString();
                    try { localStorage.setItem('spy-price', spyPrice.toString()); localStorage.setItem('spy-price-date', lastSpyUpdate); } catch(e){}
                    updateSpyAssets();
                    updateUI();
                    const s = document.getElementById('spyStatus');
                    if (s) { s.textContent = `âœ… $${spyPrice.toFixed(2)} (×™×“× ×™)`; s.style.color = 'var(--accent-green)'; }
                    return true;
                } else if (input.trim() !== '') {
                    alert('××—×™×¨ ×œ× ×ª×§×™×Ÿ. ×”×–×Ÿ ××¡×¤×¨ ×—×™×•×‘×™ (×œ×“×•×’××”: 598.50)');
                }
            }
            return false;
        }

        // ============ SPY Setup Wizard ============
        function setupFinnhubKey() { showSpySetupWizard(); }

        function showSpySetupWizard() {
            const existingKey = localStorage.getItem('finnhub-api-key') || '';
            const overlay = document.createElement('div');
            overlay.id = 'spySetupOverlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:10000;display:flex;align-items:center;justify-content:center;padding:20px;';
            overlay.innerHTML = `
                <div style="background:var(--bg-card,#1a1f3a);border-radius:20px;padding:35px;max-width:500px;width:100%;color:var(--text-primary,#e8eaf6);border:2px solid var(--accent-gold,#f4c430);box-shadow:0 20px 60px rgba(0,0,0,0.5);">
                    <div style="text-align:center;margin-bottom:25px;">
                        <div style="font-size:3rem;margin-bottom:10px;">ğŸ“ˆğŸ”‘</div>
                        <h2 style="font-size:1.5rem;margin-bottom:10px;background:linear-gradient(135deg,#f4c430,#ffd700);-webkit-background-clip:text;-webkit-text-fill-color:transparent;">×”×’×“×¨×ª ×¢×“×›×•×Ÿ SPY ××•×˜×•××˜×™</h2>
                        <p style="color:var(--text-secondary,#9ca3af);font-size:0.95rem;line-height:1.6;">
                            ×¦×¨×™×š ××¤×ª×— API ×—×™× ××™ ×-Finnhub (30 ×©× ×™×•×ª, ×‘×œ×™ ×›×¨×˜×™×¡ ××©×¨××™)
                        </p>
                    </div>
                    <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:20px;margin-bottom:20px;">
                        <div style="font-weight:600;margin-bottom:15px;font-size:1.05rem;">3 ×¦×¢×“×™×:</div>
                        <div style="display:flex;flex-direction:column;gap:12px;">
                            <div style="display:flex;align-items:center;gap:12px;">
                                <span style="background:var(--accent-gold,#f4c430);color:#000;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">1</span>
                                <span>×”×™×›× ×¡ ×œ- <a href="https://finnhub.io/register" target="_blank" rel="noopener" style="color:var(--accent-gold,#f4c430);text-decoration:underline;font-weight:600;">finnhub.io/register â†—</a></span>
                            </div>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <span style="background:var(--accent-gold,#f4c430);color:#000;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">2</span>
                                <span>×”×¨×©× ×¢× ××™××™×™×œ (×—×™× × ×œ×’××¨×™)</span>
                            </div>
                            <div style="display:flex;align-items:center;gap:12px;">
                                <span style="background:var(--accent-gold,#f4c430);color:#000;width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;flex-shrink:0;">3</span>
                                <span>×”×¢×ª×§ ××ª ×”-API Key ×•×”×“×‘×§ ×œ××˜×” â¬‡ï¸</span>
                            </div>
                        </div>
                    </div>
                    <div style="margin-bottom:20px;">
                        <label style="display:block;margin-bottom:8px;font-weight:500;font-size:0.9rem;">××¤×ª×— API ×-Finnhub:</label>
                        <input type="text" id="finnhubKeyInput" value="${existingKey}" placeholder="×”×“×‘×§ ×›××Ÿ... (××ª×—×™×œ ×‘-c...)" 
                            style="width:100%;padding:14px;border:2px solid var(--border-color,#2d3348);border-radius:10px;font-size:1rem;background:rgba(0,0,0,0.3);color:var(--text-primary,#e8eaf6);direction:ltr;text-align:left;font-family:monospace;" dir="ltr">
                        <div id="finnhubKeyError" style="color:var(--accent-red,#ef4444);font-size:0.85rem;margin-top:8px;display:none;"></div>
                        <div id="finnhubKeySuccess" style="color:var(--accent-green,#10b981);font-size:0.85rem;margin-top:8px;display:none;"></div>
                    </div>
                    <div style="display:flex;gap:10px;">
                        <button onclick="testAndSaveFinnhubKey()" id="finnhubSaveBtn" style="flex:1;padding:14px;background:linear-gradient(135deg,#f4c430,#ffd700);color:#000;border:none;border-radius:10px;font-size:1.05rem;font-weight:700;cursor:pointer;font-family:inherit;">
                            âœ… ×‘×“×•×§ ×•×©××•×¨
                        </button>
                        <button onclick="skipSpySetup()" style="padding:14px 20px;background:transparent;color:var(--text-secondary,#9ca3af);border:1px solid var(--border-color,#2d3348);border-radius:10px;cursor:pointer;font-family:inherit;">
                            ×“×œ×’
                        </button>
                    </div>
                    <div style="text-align:center;margin-top:15px;">
                        <button onclick="manualSpyEntry();closeSpySetup();" style="background:none;border:none;color:var(--text-secondary,#9ca3af);cursor:pointer;text-decoration:underline;font-family:inherit;font-size:0.85rem;">
                            ××• ×”×–×Ÿ ××—×™×¨ SPY ×™×“× ×™×ª
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            overlay.addEventListener('click', (e) => { if (e.target === overlay) closeSpySetup(); });
            setTimeout(() => { const inp = document.getElementById('finnhubKeyInput'); if (inp) inp.focus(); }, 300);
        }

        async function testAndSaveFinnhubKey() {
            const input = document.getElementById('finnhubKeyInput');
            const errEl = document.getElementById('finnhubKeyError');
            const sucEl = document.getElementById('finnhubKeySuccess');
            const btn = document.getElementById('finnhubSaveBtn');
            const key = input?.value?.trim();
            errEl.style.display = 'none'; sucEl.style.display = 'none';
            if (!key) { errEl.textContent = '× × ×œ×”×–×™×Ÿ ××¤×ª×— API'; errEl.style.display = 'block'; return; }
            btn.textContent = 'â³ ×‘×•×“×§...'; btn.disabled = true; input.disabled = true;
            try {
                const wizardController = new AbortController();
                const wizardTimeout = setTimeout(function() { wizardController.abort(); }, 10000);
                const response = await fetch(`https://finnhub.io/api/v1/quote?symbol=SPY&token=${key}`, { signal: wizardController.signal });
                clearTimeout(wizardTimeout);
                if (response.status === 401 || response.status === 403) {
                    errEl.textContent = 'âŒ ××¤×ª×— ×œ× ×ª×§×™×Ÿ. ×‘×“×•×§ ×©×”×¢×ª×§×ª × ×›×•×Ÿ ×-Finnhub Dashboard.';
                    errEl.style.display = 'block'; btn.textContent = 'âœ… ×‘×“×•×§ ×•×©××•×¨'; btn.disabled = false; input.disabled = false; return;
                }
                const data = await response.json();
                if (data?.c && data.c > 0) {
                    localStorage.setItem('finnhub-api-key', key);
                    spyPrice = data.c; lastSpyUpdate = new Date().toISOString();
                    try { localStorage.setItem('spy-price', spyPrice.toString()); localStorage.setItem('spy-price-date', lastSpyUpdate); } catch(e){}
                    sucEl.textContent = `âœ… ×¢×•×‘×“ ××¦×•×™×Ÿ! SPY: $${spyPrice.toFixed(2)}`; sucEl.style.display = 'block';
                    btn.textContent = 'ğŸ‰ × ×©××¨!';
                    updateSpyAssets(); updateUI();
                    const st = document.getElementById('spyStatus');
                    if (st) { st.textContent = `$${spyPrice.toFixed(2)}`; st.style.color = 'var(--accent-green)'; }
                    setTimeout(() => closeSpySetup(), 1500);
                } else {
                    errEl.textContent = 'âš ï¸ ×”××¤×ª×— × ×¨××” ×ª×§×™×Ÿ ××‘×œ ×œ× ×”×ª×§×‘×œ ××—×™×¨. × ×¡×” ×©×•×‘ ×¢×•×“ ×›××” ×“×§×•×ª.';
                    errEl.style.display = 'block'; btn.textContent = 'âœ… ×‘×“×•×§ ×•×©××•×¨'; btn.disabled = false; input.disabled = false;
                }
            } catch (error) {
                errEl.textContent = 'âš ï¸ ×©×’×™××ª ×¨×©×ª. ×‘×“×•×§ ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜ ×•× ×¡×” ×©×•×‘.';
                errEl.style.display = 'block'; btn.textContent = 'âœ… ×‘×“×•×§ ×•×©××•×¨'; btn.disabled = false; input.disabled = false;
            }
        }

        function closeSpySetup() { const o = document.getElementById('spySetupOverlay'); if (o) o.remove(); }
        function skipSpySetup() { localStorage.setItem('spy-setup-skipped', 'true'); closeSpySetup(); }

        // Update all SPY pension assets with new price
        function updateSpyAssets() {
            let updated = false;
            assets.forEach(asset => {
                if (asset.isSpyPension && asset.spyUnits) {
                    const valueUSD = asset.spyUnits * spyPrice;
                    asset.value = valueUSD;
                    asset.spyCurrentPrice = spyPrice;
                    
                    // Also update ILS amount if in ILS mode
                    if (asset.spyInputMode === 'ils') {
                        asset.spyAmountILS = valueUSD * exchangeRate;
                    }
                    
                    updated = true;
                }
            });
            
            if (updated) {
                saveAssets();
            }
        }

        // Manual SPY refresh
        async function refreshSpy() {
            const btn = document.getElementById('spyRefreshBtn');
            const status = document.getElementById('spyStatus');
            if (!btn || !status) { console.error('[SPY] refreshSpy: button/status not found'); return; }

            console.log('[SPY] refreshSpy clicked');
            btn.disabled = true;
            status.textContent = 'â³ ××¢×“×›×Ÿ...';
            status.style.color = 'var(--accent-gold)';
            
            try {
                const oldPrice = spyPrice;
                const success = await fetchSpyPrice();
                console.log('[SPY] refreshSpy result:', success, 'price:', spyPrice);
                
                if (success && spyPrice > 0) {
                    const change = oldPrice > 0 ? ((spyPrice - oldPrice) / oldPrice * 100).toFixed(2) : '';
                    const changeStr = change ? ` (${change > 0 ? '+' : ''}${change}%)` : '';
                    status.textContent = `âœ“ $${spyPrice.toFixed(2)}${changeStr}`;
                    status.style.color = 'var(--accent-green)';
                } else {
                    status.textContent = 'âœ— × ×›×©×œ - × ×¡×” ×™×“× ×™';
                    status.style.color = 'var(--accent-red)';
                }
            } catch (error) {
                console.error('[SPY] refreshSpy error:', error);
                status.textContent = 'âœ— ×©×’×™××”';
                status.style.color = 'var(--accent-red)';
            }
            
            btn.disabled = false;
            setTimeout(function() { if (status) status.textContent = spyPrice > 0 ? ('$' + spyPrice.toFixed(2)) : ''; }, 5000);
        }

        // Check if we have SPY assets and show/hide button
        function updateSpyButtonVisibility() {
            const hasSpyAssets = assets.some(a => a.isSpyPension);
            const display = hasSpyAssets ? 'flex' : 'none';
            
            const btn = document.getElementById('spyRefreshBtn');
            if (btn) btn.style.display = display;
        }

        // Check if US market is open (EST timezone)
        function isMarketOpen() {
            const now = new Date();
            const utcHours = now.getUTCHours();
            const utcMinutes = now.getUTCMinutes();
            const utcDay = now.getUTCDay();
            
            // Convert to EST (UTC-5 or UTC-4 for DST)
            const estHours = (utcHours - 5 + 24) % 24;
            
            // Market closed on weekends
            if (utcDay === 0 || utcDay === 6) return false;
            
            // Market hours: 9:30 AM - 4:00 PM EST
            if (estHours === 9 && utcMinutes >= 30) return true;
            if (estHours >= 10 && estHours < 16) return true;
            
            return false;
        }

        // Auto-update SPY - every minute when market open, every 5 min otherwise
        setInterval(() => {
            const hasSpyAssets = assets.some(a => a.isSpyPension);
            if (!hasSpyAssets) return;
            
            if (isMarketOpen()) {
                fetchSpyPrice();
            }
        }, 60000);

        // Retry SPY fetch after initial failure (try again after 10s, 30s, 60s)
        let spyRetryCount = 0;
        function retrySpyFetch() {
            if (spyPrice > 0 || spyRetryCount >= 3) return;
            const hasSpyAssets = assets.some(a => a.isSpyPension);
            if (!hasSpyAssets) return;
            
            spyRetryCount++;
            const delay = [10000, 30000, 60000][spyRetryCount - 1] || 60000;
            console.log(`SPY retry ${spyRetryCount} in ${delay/1000}s...`);
            setTimeout(async () => {
                const success = await fetchSpyPrice();
                if (!success) retrySpyFetch();
            }, delay);
        }

        // Fetch current exchange rates from API
        async function fetchExchangeRate() {
            try {
                var prevRate = exchangeRate;

                // Source 1: Frankfurter API (ECB data, more accurate, free)
                var gotUSD = false;
                try {
                    var fResp = await fetch('https://api.frankfurter.dev/v1/latest?from=USD&to=ILS');
                    if (fResp.ok) {
                        var fData = await fResp.json();
                        if (fData && fData.rates && fData.rates.ILS) {
                            exchangeRate = fData.rates.ILS;
                            gotUSD = true;
                            console.log('[Rate] Frankfurter USD/ILS:', exchangeRate);
                        }
                    }
                } catch(e) { console.warn('[Rate] Frankfurter failed:', e.message); }

                // Source 2: Fallback to exchangerate-api
                if (!gotUSD) {
                    try {
                        var eResp = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                        var eData = await eResp.json();
                        if (eData && eData.rates && eData.rates.ILS) {
                            exchangeRate = eData.rates.ILS;
                            gotUSD = true;
                            console.log('[Rate] exchangerate-api USD/ILS:', exchangeRate);
                        }
                    } catch(e) { console.warn('[Rate] exchangerate-api failed:', e.message); }
                }

                // Store previous close for daily change
                try {
                    var savedPrev = localStorage.getItem('usdils-prev-close');
                    var savedPrevDate = localStorage.getItem('usdils-prev-date');
                    var today = new Date().toISOString().split('T')[0];
                    if (savedPrevDate === today && savedPrev) {
                        exchangeRatePrevClose = parseFloat(savedPrev);
                    } else {
                        // New day - save current as previous for tomorrow, use old rate as prev
                        var oldRate = parseFloat(localStorage.getItem('exchange-rate') || '0');
                        if (oldRate > 0 && oldRate !== exchangeRate) {
                            exchangeRatePrevClose = oldRate;
                        } else {
                            exchangeRatePrevClose = exchangeRate;
                        }
                        localStorage.setItem('usdils-prev-close', exchangeRatePrevClose.toString());
                        localStorage.setItem('usdils-prev-date', today);
                    }
                } catch(e) {}

                // Fetch crypto rates (BTC and ETH in USD)
                try {
                    var cryptoResponse = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin,ethereum&vs_currencies=usd');
                    var cryptoData = await cryptoResponse.json();
                    if (cryptoData && cryptoData.bitcoin) btcRate = cryptoData.bitcoin.usd;
                    if (cryptoData && cryptoData.ethereum) ethRate = cryptoData.ethereum.usd;
                } catch(e) { console.warn('[Rate] Crypto fetch failed:', e.message); }
                
                lastRateUpdate = new Date().toISOString();
                
                // Save to storage
                try {
                    localStorage.setItem('exchange-rate', exchangeRate.toString());
                    localStorage.setItem('btc-rate', btcRate.toString());
                    localStorage.setItem('eth-rate', ethRate.toString());
                    localStorage.setItem('exchange-rate-date', lastRateUpdate);
                } catch (e) {}
                
                updateRateDisplay();
                updateRateIndicator(0);
                updateUI();
                return true;
            } catch (error) {
                console.error('Failed to fetch exchange rate:', error);
                return false;
            }
        }

        function updateRateDisplay() {
            document.getElementById('exchangeRateDisplay').textContent = exchangeRate.toFixed(4);
            document.getElementById('btcRateDisplay').textContent = btcRate.toLocaleString('en-US', {maximumFractionDigits: 0});
            document.getElementById('ethRateDisplay').textContent = ethRate.toLocaleString('en-US', {maximumFractionDigits: 0});
            
            // Show daily change next to exchange rate
            var ilsChangeEl = document.getElementById('ilsDailyChange');
            if (ilsChangeEl && exchangeRatePrevClose > 0) {
                var chg = ((exchangeRate - exchangeRatePrevClose) / exchangeRatePrevClose * 100);
                ilsChangeEl.textContent = (chg >= 0 ? '+' : '') + chg.toFixed(2) + '%';
                ilsChangeEl.style.color = chg >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            }
        }

        // Toggle real estate specific fields
        function toggleRealEstateFields() {
            const assetType = document.getElementById('assetType').value;
            const realEstateFields = document.getElementById('realEstateFields');
            const spyPensionCheckbox = document.getElementById('spyPensionCheckbox');
            const currencyField = document.getElementById('currencyField');
            const valueField = document.getElementById('valueField');
            
            // Hide all special fields first
            realEstateFields.style.display = 'none';
            spyPensionCheckbox.style.display = 'none';
            document.getElementById('spyFields').style.display = 'none';
            document.getElementById('isSpyPension').checked = false;
            
            if (assetType === 'real_estate') {
                realEstateFields.style.display = 'block';
                currencyField.style.display = 'none';
                valueField.style.display = 'none';
                // Set currency to ILS for real estate
                document.getElementById('assetCurrency').value = 'ILS';
                calculateEquity();
            } else if (assetType === 'pension') {
                // Show SPY checkbox for pension
                spyPensionCheckbox.style.display = 'block';
                currencyField.style.display = 'block';
                valueField.style.display = 'block';
            } else {
                currencyField.style.display = 'block';
                valueField.style.display = 'block';
            }
        }

        // Toggle SPY fields
        function toggleSpyFields() {
            const isChecked = document.getElementById('isSpyPension').checked;
            const spyFields = document.getElementById('spyFields');
            const currencyField = document.getElementById('currencyField');
            const valueField = document.getElementById('valueField');
            
            if (isChecked) {
                spyFields.style.display = 'block';
                currencyField.style.display = 'none';
                valueField.style.display = 'none';
                // Set currency to USD for SPY
                document.getElementById('assetCurrency').value = 'USD';
                // Fetch current SPY price
                fetchSpyPrice();
                // Set default to ILS mode
                document.querySelector('input[name="spyInputMode"][value="ils"]').checked = true;
                toggleSpyInputMode();
            } else {
                spyFields.style.display = 'none';
                currencyField.style.display = 'block';
                valueField.style.display = 'block';
            }
        }

        // Toggle between ILS and Units input modes
        function toggleSpyInputMode() {
            const mode = document.querySelector('input[name="spyInputMode"]:checked').value;
            const ilsMode = document.getElementById('spyIlsMode');
            const unitsMode = document.getElementById('spyUnitsMode');
            
            if (mode === 'ils') {
                ilsMode.style.display = 'block';
                unitsMode.style.display = 'none';
                // Trigger calculation with existing values
                setTimeout(() => calculateFromILS(), 100);
            } else {
                ilsMode.style.display = 'none';
                unitsMode.style.display = 'block';
                // Copy hidden values to display fields
                document.getElementById('spyUnitsDisplay').value = document.getElementById('spyUnits').value || 0;
                document.getElementById('spyAvgPriceDisplay').value = document.getElementById('spyAvgPrice').value || 0;
                // Trigger calculation
                setTimeout(() => calculateSpyValue(), 100);
            }
        }

        // Calculate SPY units from ILS amount
        function calculateFromILS() {
            const amountILS = parseNum(document.getElementById('spyAmountILS'));
            const avgPriceUSD = parseNum(document.getElementById('spyAvgPriceILS'));
            const currentPrice = spyPrice || 0;
            
            // Display current price first
            const priceElement = document.getElementById('currentSpyPrice');
            if (priceElement) {
                if (currentPrice > 0) {
                    priceElement.textContent = `$${currentPrice.toFixed(2)}`;
                } else {
                    priceElement.textContent = '$-- (×œ×—×¥ ×œ×¢×“×›×Ÿ)';
                }
            }
            
            if (amountILS > 0 && currentPrice > 0 && exchangeRate > 0) {
                // Convert ILS to USD
                const amountUSD = amountILS / exchangeRate;
                
                // Calculate units based on current price
                const units = amountUSD / currentPrice;
                
                // Display calculated units
                const unitsElement = document.getElementById('calculatedUnitsFromILS');
                if (unitsElement) {
                    unitsElement.textContent = units.toFixed(3);
                }
                
                // Calculate return if avg price provided
                const returnEl = document.getElementById('spyReturn');
                if (returnEl) {
                    if (avgPriceUSD > 0) {
                        const returnPct = ((currentPrice - avgPriceUSD) / avgPriceUSD) * 100;
                        returnEl.textContent = `${returnPct > 0 ? '+' : ''}${returnPct.toFixed(2)}%`;
                        returnEl.style.color = returnPct >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
                    } else {
                        returnEl.textContent = '--%';
                    }
                }
                
                // Display total value
                const usdElement = document.getElementById('calculatedSpyValueUSD');
                const ilsElement = document.getElementById('calculatedSpyValue');
                if (usdElement) {
                    usdElement.textContent = `$${amountUSD.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                }
                if (ilsElement) {
                    ilsElement.textContent = `â‚ª${amountILS.toLocaleString('he-IL', {maximumFractionDigits: 0})}`;
                }
                
                // Update the hidden value field (in USD)
                const valueField = document.getElementById('assetValue');
                if (valueField) {
                    valueField.value = amountUSD;
                }
                
                // Store units and avg price in hidden fields for saving
                const unitsField = document.getElementById('spyUnits');
                const avgPriceField = document.getElementById('spyAvgPrice');
                if (unitsField) {
                    unitsField.value = units;
                }
                if (avgPriceField) {
                    avgPriceField.value = avgPriceUSD || currentPrice;
                }
            } else {
                // Reset displays
                const elements = {
                    'calculatedUnitsFromILS': '0.000',
                    'spyReturn': '--%',
                    'calculatedSpyValueUSD': '$0',
                    'calculatedSpyValue': 'â‚ª0'
                };
                
                for (const [id, value] of Object.entries(elements)) {
                    const el = document.getElementById(id);
                    if (el) {
                        el.textContent = value;
                    }
                }
                
                // Show warning if no SPY price
                if (currentPrice <= 0 && amountILS > 0) {
                    const unitsElement = document.getElementById('calculatedUnitsFromILS');
                    if (unitsElement) {
                        unitsElement.textContent = '×××ª×™×Ÿ ×œ××—×™×¨ SPY...';
                    }
                }
            }
        }

        // Calculate SPY value and return
        function calculateSpyValue() {
            const units = parseNum(document.getElementById('spyUnitsDisplay'));
            const avgPrice = parseNum(document.getElementById('spyAvgPriceDisplay'));
            const currentPrice = spyPrice || 0;
            
            // Update hidden fields
            document.getElementById('spyUnits').value = units;
            document.getElementById('spyAvgPrice').value = avgPrice;
            
            // Update current price display
            document.getElementById('currentSpyPrice').textContent = `$${currentPrice.toFixed(2)}`;
            
            // Calculate return percentage
            if (avgPrice > 0 && currentPrice > 0) {
                const returnPct = ((currentPrice - avgPrice) / avgPrice) * 100;
                const returnEl = document.getElementById('spyReturn');
                returnEl.textContent = `${returnPct > 0 ? '+' : ''}${returnPct.toFixed(2)}%`;
                returnEl.style.color = returnPct >= 0 ? 'var(--accent-green)' : 'var(--accent-red)';
            } else {
                document.getElementById('spyReturn').textContent = '--%';
            }
            
            // Calculate total value in USD
            const valueUSD = units * currentPrice;
            document.getElementById('calculatedSpyValueUSD').textContent = `$${valueUSD.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            
            // Calculate total value in ILS
            const valueILS = valueUSD * exchangeRate;
            document.getElementById('calculatedSpyValue').textContent = `â‚ª${valueILS.toLocaleString('he-IL', {maximumFractionDigits: 0})}`;
            
            // Show units
            document.getElementById('calculatedUnitsFromILS').textContent = units.toFixed(3);
            
            // Update the hidden value field (in USD)
            document.getElementById('assetValue').value = valueUSD;
        }

        // Calculate equity for real estate
        function calculateEquity() {
            const propertyValue = parseNum(document.getElementById('propertyValue'));
            const mortgage = parseNum(document.getElementById('mortgage'));
            const equity = propertyValue - mortgage;
            document.getElementById('calculatedEquity').textContent = `â‚ª${equity.toLocaleString('he-IL')}`;
            // Update the hidden value field
            document.getElementById('assetValue').value = equity;
        }

        // Add event listeners for real estate calculations
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('propertyValue')?.addEventListener('input', calculateEquity);
            document.getElementById('mortgage')?.addEventListener('input', calculateEquity);
        });

        // Check if rate needs update (every 4 hours)
        async function checkAndUpdateRate() {
            try {
                const savedDate = localStorage.getItem('exchange-rate-date');
                if (savedDate) {
                    const lastUpdate = new Date(savedDate);
                    const now = new Date();
                    const hoursSinceUpdate = (now - lastUpdate) / (1000 * 60 * 60);
                    
                    updateRateIndicator(hoursSinceUpdate);
                    
                    // Update if more than 4 hours old
                    if (hoursSinceUpdate > 4) {
                        await fetchExchangeRate();
                    }
                } else {
                    // No saved date, fetch now
                    await fetchExchangeRate();
                }
            } catch (e) {
                console.log('Rate check skipped');
            }
        }

        // Auto-update rates every 4 hours
        setInterval(function() {
            checkAndUpdateRate();
        }, 4 * 60 * 60 * 1000);

        // Update rate indicator color based on age
        function updateRateIndicator(hoursSinceUpdate) {
            const indicator = document.getElementById('rateUpdateIndicator');
            if (!indicator) return;
            
            if (hoursSinceUpdate < 6) {
                indicator.style.background = '#10b981'; // Green - fresh
            } else if (hoursSinceUpdate < 24) {
                indicator.style.background = '#f59e0b'; // Orange - getting old
            } else {
                indicator.style.background = '#ef4444'; // Red - stale
            }
        }

        // Helper function to convert to ILS
        function toILS(value, currency) {
            if (currency === 'USD') {
                return value * exchangeRate;
            } else if (currency === 'BTC') {
                return value * btcRate * exchangeRate;
            } else if (currency === 'ETH') {
                return value * ethRate * exchangeRate;
            }
            return value; // ILS
        }

        // Helper function to format amount with currency symbol
        function formatAmount(value, currency) {
            let symbol = 'â‚ª';
            if (currency === 'USD') symbol = '$';
            else if (currency === 'BTC') symbol = 'â‚¿';
            else if (currency === 'ETH') symbol = 'Î';
            
            const decimals = (currency === 'BTC' || currency === 'ETH') ? 4 : 0;
            return `${symbol}${value.toLocaleString('he-IL', {minimumFractionDigits: decimals, maximumFractionDigits: decimals})}`;
        }

        const assetTypeIcons = {
            pension: 'ğŸ¦',
            gemel: 'ğŸ’¼',
            fund: 'ğŸ“ˆ',
            savings: 'ğŸ’°',
            trade: 'ğŸ“Š',
            crypto: 'â‚¿',
            real_estate: 'ğŸ ',
            other: 'ğŸ“‹'
        };

        const assetTypeNames = {
            pension: '×¤× ×¡×™×”',
            gemel: '×’××œ',
            fund: '×§×¨×Ÿ ×”×©×ª×œ××•×ª',
            savings: '×—×™×¡×›×•×Ÿ',
            trade: '×˜×¨×™×™×“',
            crypto: '×§×¨×™×¤×˜×•',
            real_estate: '× ×“×œ"×Ÿ',
            other: '××—×¨'
        };

        const assetColors = {
            pension: '#00d9ff',
            gemel: '#b026ff',
            fund: 'var(--accent-gold)',
            savings: '#7c3aed',
            trade: '#ff006e',
            crypto: '#a855f7',
            real_estate: '#10b981',
            other: '#64748b'
        };

        async function loadAssets() {
            try {
                const data = localStorage.getItem('portfolio-assets');
                if (data) {
                    assets = JSON.parse(data);
                }
            } catch (e) {
                assets = [];
            }
            
            try {
                const rateData = localStorage.getItem('exchange-rate');
                if (rateData) {
                    exchangeRate = parseFloat(rateData);
                }
                
                const btcData = localStorage.getItem('btc-rate');
                if (btcData) {
                    btcRate = parseFloat(btcData);
                }
                
                const ethData = localStorage.getItem('eth-rate');
                if (ethData) {
                    ethRate = parseFloat(ethData);
                }
                
                const spyData = localStorage.getItem('spy-price');
                if (spyData) {
                    spyPrice = parseFloat(spyData);
                }
                
                // Load daily change data
                var spyPC = localStorage.getItem('spy-prev-close');
                if (spyPC) spyPrevClose = parseFloat(spyPC);
                var spyDC = localStorage.getItem('spy-daily-change');
                if (spyDC) spyDailyChangePct = parseFloat(spyDC);
                var usdPC = localStorage.getItem('usdils-prev-close');
                if (usdPC) exchangeRatePrevClose = parseFloat(usdPC);
                
                updateRateDisplay();
            } catch (e) {
                exchangeRate = 3.7;
                btcRate = 100000;
                ethRate = 3500;
                spyPrice = 0;
            }
            
            try {
                const dateData = localStorage.getItem('exchange-rate-date');
                if (dateData) {
                    lastRateUpdate = dateData;
                }
                
                const spyDateData = localStorage.getItem('spy-price-date');
                if (spyDateData) {
                    lastSpyUpdate = spyDateData;
                }
            } catch (e) {
                lastRateUpdate = null;
                lastSpyUpdate = null;
            }
            
            updateUI();
            
            // Check and update rate if needed (after UI loads)
            setTimeout(async () => {
                checkAndUpdateRate();
                
                // SPY: always try to fetch (we have default key)
                const hasSpyAssets = assets.some(a => a.isSpyPension);
                console.log('[SPY] Init - hasSpyAssets:', hasSpyAssets, 'total assets:', assets.length);
                if (hasSpyAssets) {
                    console.log('[SPY] Init - calling fetchSpyPrice...');
                    const success = await fetchSpyPrice();
                    console.log('[SPY] Init - fetchSpyPrice result:', success, 'spyPrice:', spyPrice);
                    if (!success) retrySpyFetch();
                } else {
                    console.log('[SPY] Init - no SPY assets, skipping fetch');
                }
            }, 1000);
        }

        async function saveAssets() {
            try {
                localStorage.setItem('portfolio-assets', JSON.stringify(assets));
                localStorage.setItem('exchange-rate', exchangeRate.toString());
                localStorage.setItem('btc-rate', btcRate.toString());
                localStorage.setItem('eth-rate', ethRate.toString());
                updateLastUpdate();
            } catch (e) {
                console.error('Failed to save assets:', e);
            }
        }

        function updateExchangeRate() {
            const manualRate = confirm('×¨×•×¦×” ×œ××©×•×š ×©×¢×¨×™ ×”××¨×” ×¢×“×›× ×™×™× ××”××™× ×˜×¨× ×˜?\n(×“×•×œ×¨, ×‘×™×˜×§×•×™×Ÿ, ××™×ª×¨×™×•×)\n\n×œ×—×¥ "××™×©×•×¨" ×œ××©×™×›×” ××•×˜×•××˜×™×ª\n×œ×—×¥ "×‘×™×˜×•×œ" ×œ×”×–× ×” ×™×“× ×™×ª');
            
            if (manualRate) {
                // Fetch from API
                fetchExchangeRate().then(success => {
                    if (success) {
                        alert(`×©×¢×¨×™ ×”××¨×” ×¢×•×“×›× ×• ×‘×”×¦×œ×—×”!\n\nğŸ’µ $1 = â‚ª${exchangeRate.toFixed(4)}\nâ‚¿ BTC = $${btcRate.toLocaleString('en-US')}\nÎ ETH = $${ethRate.toLocaleString('en-US')}`);
                    } else {
                        alert('×œ× ×”×¦×œ×—× ×• ×œ××©×•×š ××ª ×”×©×¢×¨×™×. ×‘×“×•×§ ××ª ×”×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜.');
                    }
                });
            } else {
                // Manual input
                const newRate = prompt('×”×–×Ÿ ×©×¢×¨ ×”××¨×” ×—×“×© ×“×•×œ×¨ ×œ×©×§×œ:', exchangeRate.toFixed(4));
                if (newRate && !isNaN(newRate) && parseFloat(newRate) > 0) {
                    exchangeRate = parseFloat(newRate);
                    localStorage.setItem('exchange-rate', exchangeRate.toString());
                    updateRateDisplay();
                    updateUI();
                }
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleString('he-IL');
        }

        function openModal(mode, assetId = null) {
            const modal = document.getElementById('assetModal');
            const form = document.getElementById('assetForm');
            const title = document.getElementById('modalTitle');

            if (mode === 'edit' && assetId !== null) {
                const asset = assets.find(a => a.id === assetId);
                if (asset) {
                    title.textContent = '×¢×¨×•×š × ×›×¡';
                    document.getElementById('assetType').value = asset.type;
                    document.getElementById('assetName').value = asset.name;
                    document.getElementById('assetProvider').value = asset.provider;
                    document.getElementById('assetCurrency').value = asset.currency || 'ILS';
                    document.getElementById('assetValue').value = formatNum(asset.value);
                    document.getElementById('assetReturn').value = formatNum(asset.return || 0);
                    document.getElementById('assetMonthly').value = formatNum(asset.monthly || 0);
                    
                    // Handle real estate fields
                    if (asset.type === 'real_estate') {
                        document.getElementById('propertyValue').value = formatNum(asset.propertyValue || 0);
                        document.getElementById('mortgage').value = formatNum(asset.mortgage || 0);
                    }
                    
                    // Handle SPY pension fields
                    if (asset.type === 'pension' && asset.isSpyPension) {
                        document.getElementById('isSpyPension').checked = true;
                        
                        // Set hidden fields
                        document.getElementById('spyUnits').value = asset.spyUnits || 0;
                        document.getElementById('spyAvgPrice').value = asset.spyAvgPrice || 0;
                        
                        // Set input mode and load appropriate fields
                        const inputMode = asset.spyInputMode || 'units';
                        if (inputMode === 'ils') {
                            document.querySelector('input[name="spyInputMode"][value="ils"]').checked = true;
                            document.getElementById('spyAmountILS').value = formatNum(asset.spyAmountILS || 0);
                            document.getElementById('spyAvgPriceILS').value = formatNum(asset.spyAvgPrice || 0);
                        } else {
                            document.querySelector('input[name="spyInputMode"][value="units"]').checked = true;
                            document.getElementById('spyUnitsDisplay').value = asset.spyUnits || 0;
                            document.getElementById('spyAvgPriceDisplay').value = formatNum(asset.spyAvgPrice || 0);
                        }
                        
                        toggleSpyFields();
                    }
                    
                    toggleRealEstateFields();
                    editingAssetId = assetId;
                    // Show delete button in edit mode
                    var delBtn = document.getElementById('deleteAssetBtn');
                    if (delBtn) delBtn.style.display = '';
                }
            } else {
                title.textContent = '×”×•×¡×£ × ×›×¡ ×—×“×©';
                form.reset();
                toggleRealEstateFields();
                editingAssetId = null;
                // Hide delete button in add mode
                var delBtn = document.getElementById('deleteAssetBtn');
                if (delBtn) delBtn.style.display = 'none';
            }

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('assetModal').classList.remove('active');
            document.getElementById('assetForm').reset();
            document.getElementById('realEstateFields').style.display = 'none';
            document.getElementById('spyPensionCheckbox').style.display = 'none';
            document.getElementById('spyFields').style.display = 'none';
            document.getElementById('currencyField').style.display = 'block';
            document.getElementById('valueField').style.display = 'block';
            var delBtn = document.getElementById('deleteAssetBtn');
            if (delBtn) delBtn.style.display = 'none';
            editingAssetId = null;
        }

        document.getElementById('assetForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const assetType = document.getElementById('assetType').value;
            const isSpy = assetType === 'pension' && document.getElementById('isSpyPension').checked;
            const isRealEstate = assetType === 'real_estate';

            // Validate: value is required unless it's SPY pension or real estate (which calculate it)
            if (!isSpy && !isRealEstate) {
                const val = parseNum(document.getElementById('assetValue'));
                if (!val && val !== 0) {
                    alert('× × ×œ×”×–×™×Ÿ ×©×•×•×™ × ×•×›×—×™');
                    return;
                }
            }

            const asset = {
                id: editingAssetId || Date.now(),
                type: assetType,
                name: document.getElementById('assetName').value,
                provider: document.getElementById('assetProvider').value,
                currency: document.getElementById('assetCurrency').value,
                value: parseNum(document.getElementById('assetValue')),
                return: parseNum(document.getElementById('assetReturn')),
                monthly: parseNum(document.getElementById('assetMonthly'))
            };

            // Add real estate specific fields
            if (assetType === 'real_estate') {
                asset.propertyValue = parseNum(document.getElementById('propertyValue'));
                asset.mortgage = parseNum(document.getElementById('mortgage'));
            }

            // Add SPY pension specific fields
            if (assetType === 'pension' && document.getElementById('isSpyPension').checked) {
                asset.isSpyPension = true;
                asset.spyUnits = parseFloat(document.getElementById('spyUnits').value) || 0;
                asset.spyAvgPrice = parseFloat(document.getElementById('spyAvgPrice').value) || 0;
                asset.spyCurrentPrice = spyPrice;
                
                // Save input mode
                const inputMode = document.querySelector('input[name="spyInputMode"]:checked').value;
                asset.spyInputMode = inputMode;
                
                // If ILS mode, save the ILS amount too
                if (inputMode === 'ils') {
                    asset.spyAmountILS = parseNum(document.getElementById('spyAmountILS'));
                }
            }

            if (editingAssetId) {
                const index = assets.findIndex(a => a.id === editingAssetId);
                assets[index] = asset;
            } else {
                assets.push(asset);
            }

            await saveAssets();
            updateUI();
            closeModal();
        });

        function deleteAsset(id) {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ × ×›×¡ ×–×”?')) {
                assets = assets.filter(a => a.id !== id);
                saveAssets();
                updateUI();
            }
        }

        function deleteCurrentAsset() {
            if (editingAssetId !== null) {
                var asset = assets.find(function(a) { return a.id === editingAssetId; });
                var name = asset ? asset.name : '';
                if (confirm('×œ××—×•×§ ××ª "' + name + '"?\n\n×¤×¢×•×œ×” ×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.')) {
                    assets = assets.filter(function(a) { return a.id !== editingAssetId; });
                    closeModal();
                    saveAssets();
                    updateUI();
                }
            }
        }

        function updateUI() {
            updateTotalWorth();
            updateStats();
            updateAssetsGrid();
            updateChart();
            updateSpyButtonVisibility();
            saveHistorySnapshot();
            renderHistoryChart();
        }

        function updateTotalWorth() {
            const totalILS = assets.reduce((sum, asset) => {
                return sum + toILS(asset.value, asset.currency || 'ILS');
            }, 0);
            const totalUSD = totalILS / exchangeRate;
            
            document.getElementById('totalWorth').textContent = `â‚ª${totalILS.toLocaleString('he-IL', {maximumFractionDigits: 0})}`;
            
            // Breakdown by category
            const pensionILS = assets
                .filter(a => a.type === 'pension' || a.type === 'gemel' || a.type === 'fund')
                .reduce((s, a) => s + toILS(a.value, a.currency || 'ILS'), 0);
            const realEstateILS = assets
                .filter(a => a.type === 'real_estate')
                .reduce((s, a) => s + toILS(a.value, a.currency || 'ILS'), 0);
            const liquidILS = totalILS - pensionILS - realEstateILS;
            
            var fmt = function(v) { return 'â‚ª' + v.toLocaleString('he-IL', {maximumFractionDigits: 0}); };
            var el;
            el = document.getElementById('totalLiquid'); if (el) el.textContent = fmt(liquidILS);
            el = document.getElementById('totalPension'); if (el) el.textContent = fmt(pensionILS);
            el = document.getElementById('totalRealEstate'); if (el) el.textContent = fmt(realEstateILS);
            
            var breakdownEl = document.getElementById('totalBreakdown');
            if (breakdownEl) breakdownEl.style.display = assets.length > 0 ? 'flex' : 'none';
            
            // Calculate monthly change
            const monthlyChange = assets.reduce((sum, asset) => {
                const valueInILS = toILS(asset.value, asset.currency || 'ILS');
                const monthlyGain = (valueInILS * (asset.return / 100) / 12);
                const monthlyDeposit = toILS(asset.monthly || 0, asset.currency || 'ILS');
                return sum + monthlyGain + monthlyDeposit;
            }, 0);
            
            const changePercent = totalILS > 0 ? (monthlyChange / totalILS * 100) : 0;
            const changeElement = document.getElementById('totalChange');
            
            if (monthlyChange >= 0) {
                changeElement.className = 'total-change positive';
                changeElement.innerHTML = `
                    <span>â–²</span>
                    <span>+â‚ª${monthlyChange.toLocaleString('he-IL', {maximumFractionDigits: 0})} (${changePercent.toFixed(1)}%)</span>
                    <span>×”×—×•×“×©</span>
                `;
            } else {
                changeElement.className = 'total-change negative';
                changeElement.innerHTML = `
                    <span>â–¼</span>
                    <span>-â‚ª${Math.abs(monthlyChange).toLocaleString('he-IL', {maximumFractionDigits: 0})} (${Math.abs(changePercent).toFixed(1)}%)</span>
                    <span>×”×—×•×“×©</span>
                `;
            }
        }

        function updateStats() {
            var container = document.getElementById('categoryStats');
            if (!container) return;

            // Group by type
            var groups = {};
            assets.forEach(function(a) {
                var t = a.type;
                if (!groups[t]) groups[t] = { total: 0, count: 0, returns: [] };
                groups[t].total += toILS(a.value, a.currency || 'ILS');
                groups[t].count++;
                if (a.return) groups[t].returns.push(a.return);
            });

            var totalAll = assets.reduce(function(s, a) { return s + toILS(a.value, a.currency || 'ILS'); }, 0);

            // Sort by total value descending
            var sorted = Object.entries(groups).sort(function(a, b) { return b[1].total - a[1].total; });

            // Build cards
            var html = '';
            sorted.forEach(function(entry) {
                var type = entry[0];
                var data = entry[1];
                var pct = totalAll > 0 ? (data.total / totalAll * 100) : 0;
                var avgRet = data.returns.length > 0 ? (data.returns.reduce(function(s,v){return s+v;}, 0) / data.returns.length) : 0;
                var retClass = avgRet >= 0 ? 'positive' : 'negative';
                var retSign = avgRet >= 0 ? '+' : '';

                html += '<div class="stat-card">' +
                    '<div class="stat-icon">' + (assetTypeIcons[type] || 'ğŸ“‹') + '</div>' +
                    '<div class="stat-label">' + (assetTypeNames[type] || type) + ' (' + data.count + ')</div>' +
                    '<div class="stat-value">â‚ª' + data.total.toLocaleString('he-IL', {maximumFractionDigits: 0}) + '</div>' +
                    '<div class="stat-change ' + retClass + '">' +
                        '<span>' + pct.toFixed(0) + '% ××”×ª×™×§</span>' +
                    '</div>' +
                '</div>';
            });

            // Summary card
            var avgReturn = assets.length > 0 ? assets.reduce(function(s,a){return s+(a.return||0);}, 0) / assets.length : 0;
            html += '<div class="stat-card">' +
                '<div class="stat-icon">ğŸ“Š</div>' +
                '<div class="stat-label">×¡×”"×› × ×›×¡×™×</div>' +
                '<div class="stat-value">' + assets.length + '</div>' +
                '<div class="stat-change ' + (avgReturn >= 0 ? 'positive' : 'negative') + '">' +
                    '<span>×ª×©×•××” Ã¸ ' + (avgReturn >= 0 ? '+' : '') + avgReturn.toFixed(1) + '%</span>' +
                '</div>' +
            '</div>';

            container.innerHTML = html;
        }

        // ============ SORTING ============
        var currentSort = 'value';
        function sortAssets(by) {
            currentSort = by;
            // Update button styles
            document.querySelectorAll('.sort-btn').forEach(function(btn) {
                btn.style.background = 'transparent';
                btn.style.color = 'var(--text-secondary)';
                btn.classList.remove('active-sort');
            });
            event.target.style.background = 'rgba(244,196,48,0.15)';
            event.target.style.color = 'var(--accent-gold)';
            event.target.classList.add('active-sort');

            if (by === 'value') {
                assets.sort(function(a, b) { return toILS(b.value, b.currency||'ILS') - toILS(a.value, a.currency||'ILS'); });
            } else if (by === 'type') {
                assets.sort(function(a, b) { return (a.type || '').localeCompare(b.type || ''); });
            } else if (by === 'return') {
                assets.sort(function(a, b) { return (b.return || 0) - (a.return || 0); });
            } else if (by === 'name') {
                assets.sort(function(a, b) { return (a.name || '').localeCompare(b.name || '', 'he'); });
            }
            updateAssetsGrid();
        }

        // ============ HISTORY TRACKING ============
        function saveHistorySnapshot() {
            try {
                var history = JSON.parse(localStorage.getItem('portfolio-history') || '[]');
                var total = assets.reduce(function(s, a) { return s + toILS(a.value, a.currency || 'ILS'); }, 0);
                if (total <= 0 && history.length === 0) return;

                var today = new Date().toISOString().split('T')[0];
                // Only one snapshot per day
                var lastEntry = history.length > 0 ? history[history.length - 1] : null;
                if (lastEntry && lastEntry.date === today) {
                    history[history.length - 1].value = total;
                } else {
                    history.push({ date: today, value: total });
                }
                // Keep last 365 days
                if (history.length > 365) history = history.slice(-365);
                localStorage.setItem('portfolio-history', JSON.stringify(history));
            } catch(e) {}
        }

        function renderHistoryChart() {
            var section = document.getElementById('historySection');
            var canvas = document.getElementById('historyChart');
            var emptyMsg = document.getElementById('historyEmpty');
            if (!section || !canvas) return;

            var history = [];
            try { history = JSON.parse(localStorage.getItem('portfolio-history') || '[]'); } catch(e) {}

            if (history.length < 2) {
                section.style.display = 'block';
                canvas.style.display = 'none';
                emptyMsg.style.display = 'block';
                return;
            }

            section.style.display = 'block';
            canvas.style.display = 'block';
            emptyMsg.style.display = 'none';

            var ctx = canvas.getContext('2d');
            var dpr = window.devicePixelRatio || 1;
            var rect = canvas.getBoundingClientRect();
            canvas.width = rect.width * dpr;
            canvas.height = 180 * dpr;
            ctx.scale(dpr, dpr);
            var W = rect.width;
            var H = 180;

            var values = history.map(function(h) { return h.value; });
            var minV = Math.min.apply(null, values) * 0.95;
            var maxV = Math.max.apply(null, values) * 1.05;
            if (maxV === minV) maxV = minV + 1;

            var padL = 70, padR = 15, padT = 15, padB = 35;
            var chartW = W - padL - padR;
            var chartH = H - padT - padB;

            ctx.clearRect(0, 0, W, H);

            // Grid lines
            ctx.strokeStyle = 'rgba(255,255,255,0.06)';
            ctx.lineWidth = 1;
            for (var g = 0; g < 4; g++) {
                var gy = padT + (chartH / 3) * g;
                ctx.beginPath(); ctx.moveTo(padL, gy); ctx.lineTo(W - padR, gy); ctx.stroke();
                var gv = maxV - (maxV - minV) * (g / 3);
                ctx.fillStyle = 'rgba(255,255,255,0.4)';
                ctx.font = '11px sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText('â‚ª' + Math.round(gv).toLocaleString('he-IL'), padL - 8, gy + 4);
            }

            // Draw line
            var gradient = ctx.createLinearGradient(0, padT, 0, H - padB);
            gradient.addColorStop(0, 'rgba(244,196,48,0.3)');
            gradient.addColorStop(1, 'rgba(244,196,48,0)');

            ctx.beginPath();
            var points = [];
            for (var i = 0; i < values.length; i++) {
                var x = padL + (i / (values.length - 1)) * chartW;
                var y = padT + (1 - (values[i] - minV) / (maxV - minV)) * chartH;
                points.push({x: x, y: y});
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.strokeStyle = '#f4c430';
            ctx.lineWidth = 2.5;
            ctx.stroke();

            // Fill area
            ctx.lineTo(points[points.length-1].x, H - padB);
            ctx.lineTo(points[0].x, H - padB);
            ctx.closePath();
            ctx.fillStyle = gradient;
            ctx.fill();

            // Dots on first and last
            [points[0], points[points.length-1]].forEach(function(p) {
                ctx.beginPath();
                ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
                ctx.fillStyle = '#f4c430';
                ctx.fill();
            });

            // Date labels
            ctx.fillStyle = 'rgba(255,255,255,0.4)';
            ctx.font = '10px sans-serif';
            ctx.textAlign = 'center';
            var firstDate = history[0].date.split('-');
            var lastDate = history[history.length-1].date.split('-');
            ctx.fillText(firstDate[2]+'/'+firstDate[1], points[0].x, H - 8);
            ctx.fillText(lastDate[2]+'/'+lastDate[1], points[points.length-1].x, H - 8);

            // Change indicator
            var firstVal = values[0];
            var lastVal = values[values.length - 1];
            var changePct = firstVal > 0 ? ((lastVal - firstVal) / firstVal * 100) : 0;
            ctx.font = 'bold 12px sans-serif';
            ctx.textAlign = 'right';
            ctx.fillStyle = changePct >= 0 ? '#10b981' : '#ef4444';
            ctx.fillText((changePct >= 0 ? '+' : '') + changePct.toFixed(1) + '%', W - padR, padT + 12);
        }

        function showInsights() {
            const section = document.getElementById('insightsSection');
            const isVisible = section.style.display !== 'none';
            
            if (isVisible) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            generateInsights();
        }

        function generateInsights() {
            const insightsGrid = document.getElementById('insightsGrid');
            const insights = [];
            
            const total = assets.reduce((sum, a) => sum + toILS(a.value, a.currency || 'ILS'), 0);
            
            // Insight 1: Diversification
            const assetTypes = new Set(assets.map(a => a.type)).size;
            if (assetTypes < 3 && assets.length > 0) {
                insights.push({
                    icon: 'ğŸ¯',
                    title: '×¤×™×–×•×¨ × ×›×¡×™×',
                    text: `×™×© ×œ×š ${assetTypes} ×¡×•×’×™ × ×›×¡×™× ×‘×œ×‘×“. ×©×§×•×œ ×œ×”×•×¡×™×£ ×¢×•×“ ×¡×•×’×™× ×œ×¤×™×–×•×¨ ×˜×•×‘ ×™×•×ª×¨ ×•×œ×”×¤×—×ª×ª ×¡×™×›×•×Ÿ.`
                });
            } else if (assetTypes >= 4) {
                insights.push({
                    icon: 'âœ…',
                    title: '×¤×™×–×•×¨ ××¦×•×™×Ÿ',
                    text: `×”×¤×•×¨×˜×¤×•×œ×™×• ×©×œ×š ××¤×•×–×¨ ×¢×œ ×¤× ×™ ${assetTypes} ×¡×•×’×™ × ×›×¡×™× - ×–×” ××¦×•×™×Ÿ ×œ× ×™×”×•×œ ×¡×™×›×•× ×™×!`
                });
            }
            
            // Insight 2: Crypto exposure
            const cryptoTotal = assets
                .filter(a => a.type === 'crypto')
                .reduce((sum, a) => sum + toILS(a.value, a.currency || 'ILS'), 0);
            const cryptoPercent = total > 0 ? (cryptoTotal / total) * 100 : 0;
            
            if (cryptoPercent > 20) {
                insights.push({
                    icon: 'âš ï¸',
                    title: '×—×©×™×¤×” ×œ×§×¨×™×¤×˜×•',
                    text: `${cryptoPercent.toFixed(1)}% ××”×¤×•×¨×˜×¤×•×œ×™×• ×©×œ×š ×‘×§×¨×™×¤×˜×• - ×–×” × ×›×¡ ×ª× ×•×“×ª×™. ×©×§×•×œ ××™×–×•×Ÿ.`
                });
            }
            
            // Insight 3: Real estate
            const realEstateTotal = assets
                .filter(a => a.type === 'real_estate')
                .reduce((sum, a) => sum + toILS(a.value, a.currency || 'ILS'), 0);
            const realEstatePercent = total > 0 ? (realEstateTotal / total) * 100 : 0;
            
            if (realEstatePercent > 50) {
                insights.push({
                    icon: 'ğŸ ',
                    title: '×¨×™×›×•×– ×‘× ×“×œ"×Ÿ',
                    text: `${realEstatePercent.toFixed(1)}% ××”× ×›×¡×™× ×©×œ×š ×‘× ×“×œ"×Ÿ - ×©×§×•×œ ×¤×™×–×•×¨ ×’× ×œ× ×›×¡×™× × ×–×™×œ×™× ×™×•×ª×¨.`
                });
            }
            
            // Insight 4: Returns
            const avgReturn = assets.length > 0
                ? assets.reduce((sum, a) => sum + a.return, 0) / assets.length
                : 0;
            
            if (avgReturn > 7) {
                insights.push({
                    icon: 'ğŸš€',
                    title: '×ª×©×•××” ××¢×•×œ×”',
                    text: `×ª×©×•××” ×××•×¦×¢×ª ×©×œ ${avgReturn.toFixed(1)}% - ×”××©×š ×›×š! ×–×” ××¢×œ ×”×××•×¦×¢ ×‘×©×•×§.`
                });
            } else if (avgReturn < 3 && assets.length > 0) {
                insights.push({
                    icon: 'ğŸ’¡',
                    title: '×©×™×¤×•×¨ ×ª×©×•××”',
                    text: `×ª×©×•××” ×××•×¦×¢×ª ×©×œ ${avgReturn.toFixed(1)}% - ×©×§×•×œ × ×›×¡×™× ×¢× ×¤×•×˜× ×¦×™××œ ×’×‘×•×” ×™×•×ª×¨.`
                });
            }
            
            // Insight 5: Total wealth
            if (total > 1000000) {
                insights.push({
                    icon: 'ğŸ‰',
                    title: '×™×¢×“ ××™×œ×™×•×Ÿ!',
                    text: `××–×œ ×˜×•×‘! ×¢×‘×¨×ª ××ª ×¨×£ ×”××™×œ×™×•×Ÿ. ×¡×š ×”× ×›×¡×™× ×©×œ×š: â‚ª${(total/1000000).toFixed(2)}M`
                });
            }
            
            // Default insight if none
            if (insights.length === 0) {
                insights.push({
                    icon: 'ğŸ“Š',
                    title: '×”×ª×—×œ ×œ×‘× ×•×ª',
                    text: '×”×•×¡×£ ×¢×•×“ × ×›×¡×™× ×›×“×™ ×œ×§×‘×œ ×ª×•×‘× ×•×ª ×•×”××œ×¦×•×ª ××•×ª×××•×ª ××™×©×™×ª ×œ×¤×•×¨×˜×¤×•×œ×™×• ×©×œ×š.'
                });
            }
            
            insightsGrid.innerHTML = insights.map(insight => `
                <div class="insight-card">
                    <div class="insight-content">
                        <div class="insight-icon">${insight.icon}</div>
                        <div class="insight-title">${insight.title}</div>
                        <div class="insight-text">${insight.text}</div>
                    </div>
                </div>
            `).join('');
        }

        function showDataMenu() {
            var overlay = document.createElement('div');
            overlay.id = 'dataMenuOverlay';
            overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:2000;display:flex;align-items:center;justify-content:center;animation:fadeIn 0.2s ease;';
            overlay.onclick = function(e) { if (e.target === overlay) overlay.remove(); };
            
            var menu = document.createElement('div');
            menu.style.cssText = 'background:var(--bg-card,#1a1f3a);border:1px solid var(--accent-gold,#f4c430);border-radius:20px;padding:30px;max-width:340px;width:90%;text-align:center;';
            menu.innerHTML = `
                <div style="font-size:2rem;margin-bottom:12px;">ğŸ’¾</div>
                <div style="font-size:1.2rem;font-weight:600;margin-bottom:6px;">× ×™×”×•×œ × ×ª×•× ×™×</div>
                <div style="font-size:0.8rem;color:var(--text-secondary);margin-bottom:24px;">×™×™×¦×•× ××• ×™×™×‘×•× ×’×™×‘×•×™ ×©×œ ×”× ×›×¡×™× ×©×œ×š</div>
                <div style="display:flex;flex-direction:column;gap:10px;">
                    <button onclick="exportData();document.getElementById('dataMenuOverlay').remove();" style="padding:14px;background:linear-gradient(135deg,var(--accent-gold),#ffd700);color:#0a0e27;border:none;border-radius:12px;font-size:0.95rem;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:8px;">
                        ğŸ“¤ ×™×™×¦×•× × ×ª×•× ×™×
                    </button>
                    <button onclick="importData();document.getElementById('dataMenuOverlay').remove();" style="padding:14px;background:rgba(59,130,246,0.15);color:#60a5fa;border:1px solid rgba(59,130,246,0.3);border-radius:12px;font-size:0.95rem;font-weight:600;cursor:pointer;font-family:inherit;display:flex;align-items:center;justify-content:center;gap:8px;">
                        ğŸ“¥ ×™×™×‘×•× × ×ª×•× ×™×
                    </button>
                    <button onclick="document.getElementById('dataMenuOverlay').remove();" style="padding:12px;background:transparent;color:var(--text-secondary);border:1px solid var(--border-color);border-radius:12px;font-size:0.85rem;cursor:pointer;font-family:inherit;margin-top:4px;">
                        ×‘×™×˜×•×œ
                    </button>
                </div>
            `;
            overlay.appendChild(menu);
            document.body.appendChild(overlay);
        }

        function exportData() {
            if (assets.length === 0) {
                alert('××™×Ÿ × ×ª×•× ×™× ×œ×™×™×¦×•×. ×”×•×¡×£ × ×›×¡×™× ×ª×—×™×œ×”.');
                return;
            }
            
            // Export full raw assets for re-import
            const backup = {
                version: 1,
                exportDate: new Date().toISOString(),
                assets: assets,
                settings: {
                    exchangeRate: exchangeRate,
                    btcRate: btcRate,
                    ethRate: ethRate,
                    spyPrice: spyPrice
                }
            };
            
            const jsonStr = JSON.stringify(backup, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `portfolio-backup-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('âœ… ×”× ×ª×•× ×™× ×™×•×¦××• ×‘×”×¦×œ×—×”!\n\nğŸ“ ×©× ×”×§×•×‘×¥:\nportfolio-backup-' + new Date().toISOString().split('T')[0] + '.json\n\n×©××•×¨ ××ª ×”×§×•×‘×¥ ×‘××§×•× ×‘×˜×•×— ×œ×’×™×‘×•×™.');
        }

        function importData() {
            var input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.style.display = 'none';
            
            input.onchange = function(e) {
                var file = e.target.files[0];
                if (!file) return;
                
                var reader = new FileReader();
                reader.onload = function(ev) {
                    try {
                        var data = JSON.parse(ev.target.result);
                        var importedAssets = null;
                        
                        // Support both backup format (version 1) and raw array
                        if (data.version && data.assets && Array.isArray(data.assets)) {
                            importedAssets = data.assets;
                        } else if (Array.isArray(data)) {
                            importedAssets = data;
                        } else if (data.assets && Array.isArray(data.assets)) {
                            importedAssets = data.assets;
                        }
                        
                        if (!importedAssets || importedAssets.length === 0) {
                            alert('âŒ ×”×§×•×‘×¥ ×œ× ××›×™×œ × ×›×¡×™× ×ª×§×™× ×™×.');
                            return;
                        }
                        
                        // Validate basic structure
                        var valid = importedAssets.every(function(a) {
                            return a.name && a.type;
                        });
                        
                        if (!valid) {
                            alert('âŒ ××‘× ×” ×”×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ. ×•×“× ×©×–×”×• ×§×•×‘×¥ ×’×™×‘×•×™ ×©×™×•×¦× ××”××¤×œ×™×§×¦×™×”.');
                            return;
                        }
                        
                        // Ask user: replace or merge
                        var hasExisting = assets.length > 0;
                        var action = 'replace';
                        
                        if (hasExisting) {
                            var choice = confirm(
                                'ğŸ“¥ × ××¦××• ' + importedAssets.length + ' × ×›×¡×™× ×‘×§×•×‘×¥.\n\n' +
                                '×™×© ×œ×š ×›×¨×’×¢ ' + assets.length + ' × ×›×¡×™×.\n\n' +
                                '×œ×—×¥ OK ×œ×”×—×œ×™×£ ××ª ×›×œ ×”× ×›×¡×™× ×”×§×™×™××™×,\n' +
                                '××• Cancel ×œ×”×•×¡×™×£ ××ª ×”× ×›×¡×™× ×”×—×“×©×™× ×œ×§×™×™××™×.'
                            );
                            action = choice ? 'replace' : 'merge';
                        }
                        
                        if (action === 'replace') {
                            assets = importedAssets;
                        } else {
                            // Merge: add imported assets with new IDs
                            var maxId = assets.reduce(function(m, a) { return Math.max(m, a.id || 0); }, 0);
                            importedAssets.forEach(function(a) {
                                maxId++;
                                a.id = maxId;
                                assets.push(a);
                            });
                        }
                        
                        // Restore settings if available
                        if (data.settings) {
                            if (data.settings.exchangeRate) exchangeRate = data.settings.exchangeRate;
                            if (data.settings.btcRate) btcRate = data.settings.btcRate;
                            if (data.settings.ethRate) ethRate = data.settings.ethRate;
                            if (data.settings.spyPrice) {
                                spyPrice = data.settings.spyPrice;
                                try { localStorage.setItem('spy-price', spyPrice.toString()); } catch(e) {}
                            }
                            updateRateDisplay();
                        }
                        
                        saveAssets();
                        updateUI();
                        
                        alert('âœ… ×”×™×™×‘×•× ×”×•×©×œ× ×‘×”×¦×œ×—×”!\n\n' + 
                              (action === 'replace' ? '×”×•×—×œ×¤×•' : '× ×•×¡×¤×•') + ' ' + 
                              importedAssets.length + ' × ×›×¡×™×.\n' +
                              '×¡×”"×› × ×›×¡×™×: ' + assets.length);
                        
                    } catch (err) {
                        alert('âŒ ×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥:\n' + err.message + '\n\n×•×“× ×©×–×”×• ×§×•×‘×¥ JSON ×ª×§×™×Ÿ.');
                    }
                };
                reader.readAsText(file);
            };
            
            document.body.appendChild(input);
            input.click();
            document.body.removeChild(input);
        }

        function toggleAssetExpand(assetId, event) {
            if (event) event.stopPropagation();
            var row = document.querySelector('[data-asset-id="' + assetId + '"]');
            if (!row) return;
            var expand = row.querySelector('.asset-row-expand');
            if (!expand) return;
            var isOpen = row.classList.contains('expanded');
            // Close all others
            document.querySelectorAll('.asset-row.expanded').forEach(function(r) {
                if (r !== row) {
                    r.classList.remove('expanded');
                    var ex = r.querySelector('.asset-row-expand');
                    if (ex) ex.classList.remove('open');
                }
            });
            if (isOpen) {
                row.classList.remove('expanded');
                expand.classList.remove('open');
            } else {
                row.classList.add('expanded');
                expand.classList.add('open');
            }
        }

        function editAsset(assetId, event) {
            if (event) event.stopPropagation();
            openModal('edit', assetId);
        }

        function updateAssetsGrid() {
            const grid = document.getElementById('assetsGrid');
            
            if (assets.length === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <div style="font-size: 4rem; margin-bottom: 20px; opacity: 0.3;">ğŸ“Š</div>
                        <h3 style="margin-bottom: 10px;">××™×Ÿ × ×›×¡×™× ×¢×“×™×™×Ÿ</h3>
                        <p>×”×ª×—×œ ×œ×”×•×¡×™×£ ××ª ×”× ×›×¡×™× ×”×¤×™× × ×¡×™×™× ×©×œ×š</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = assets.map((asset, idx) => {
                const currency = asset.currency || 'ILS';
                const valueInILS = toILS(asset.value, currency);
                const retPct = asset.return || 0;
                const retClass = retPct >= 0 ? 'positive' : 'negative';
                const retSign = retPct > 0 ? '+' : '';
                const icon = assetTypeIcons[asset.type] || 'ğŸ“‹';
                const typeName = assetTypeNames[asset.type] || asset.type;
                const delay = Math.min(idx * 0.05, 0.4);
                const editBtn = `<button class="asset-row-edit-btn" onclick="editAsset(${asset.id}, event)">âœï¸ ×¢×¨×™×›×”</button>`;
                
                // ===== REAL ESTATE =====
                if (asset.type === 'real_estate') {
                    const pv = asset.propertyValue || 0;
                    const mg = asset.mortgage || 0;
                    const eq = asset.value;
                    const pctOwned = pv > 0 ? ((eq / pv) * 100) : 0;
                    return `
                    <div class="asset-row" data-asset-id="${asset.id}" style="animation-delay:${delay}s" onclick="toggleAssetExpand(${asset.id})">
                        <div class="asset-row-main">
                            <div class="asset-row-icon" style="background:rgba(16,185,129,0.1);">${icon}</div>
                            <div class="asset-row-info">
                                <div class="asset-row-name">${asset.name}</div>
                                <div class="asset-row-provider">${asset.provider}</div>
                            </div>
                            <div class="asset-row-values">
                                <div class="asset-row-amount">â‚ª${eq.toLocaleString('he-IL', {maximumFractionDigits: 0})}</div>
                                <div class="asset-row-sub">×”×•×Ÿ ×¢×¦××™</div>
                            </div>
                            <div class="asset-row-chevron">â–¼</div>
                        </div>
                        <div class="asset-row-expand">
                            <div class="asset-row-details">
                                <div class="asset-row-detail">
                                    <span class="asset-row-detail-label">×©×•×•×™ × ×›×¡</span>
                                    <span class="asset-row-detail-value">â‚ª${pv.toLocaleString('he-IL', {maximumFractionDigits: 0})}</span>
                                </div>
                                <div class="asset-row-detail">
                                    <span class="asset-row-detail-label">××©×›× ×ª×</span>
                                    <span class="asset-row-detail-value" style="color:var(--accent-red);">â‚ª${mg.toLocaleString('he-IL', {maximumFractionDigits: 0})}</span>
                                </div>
                                <div class="asset-row-detail">
                                    <span class="asset-row-detail-label">××—×•×– ×‘×¢×œ×•×ª</span>
                                    <span class="asset-row-detail-value">${pctOwned.toFixed(1)}%</span>
                                </div>
                                <div class="asset-row-detail">
                                    <span class="asset-row-detail-label">×¡×•×’</span>
                                    <span class="asset-row-detail-value">${typeName}</span>
                                </div>
                            </div>
                            ${editBtn}
                        </div>
                    </div>`;
                }
                
                // ===== SPY PENSION =====
                if (asset.type === 'pension' && asset.isSpyPension) {
                    const units = asset.spyUnits || 0;
                    const avgP = asset.spyAvgPrice || 0;
                    const curP = spyPrice || asset.spyCurrentPrice || 0;
                    const vUSD = units * curP;
                    const vILS = vUSD * exchangeRate;
                    const rPct = avgP > 0 ? ((curP - avgP) / avgP * 100) : 0;
                    const rCls = rPct >= 0 ? 'positive' : 'negative';
                    
                    const spyDPct = spyDailyChangePct || 0;
                    const ilsDPct = exchangeRatePrevClose > 0 ? ((exchangeRate - exchangeRatePrevClose) / exchangeRatePrevClose * 100) : 0;
                    const combPct = spyDPct + ilsDPct;
                    const dailyILS = vILS * (combPct / 100);
                    const c = function(v) { return v >= 0 ? 'var(--accent-green)' : 'var(--accent-red)'; };
                    const s = function(v) { return v >= 0 ? '+' : ''; };
                    const profitUSD = vUSD - (units * avgP);
                    const profitILS = profitUSD * exchangeRate;

                    return `
                    <div class="asset-row spy-row" data-asset-id="${asset.id}" style="animation-delay:${delay}s" onclick="toggleAssetExpand(${asset.id})">
                        <div class="asset-row-main">
                            <div class="asset-row-icon" style="background:rgba(244,196,48,0.12);">${icon}</div>
                            <div class="asset-row-info">
                                <div class="asset-row-name">${asset.name} <span style="font-size:0.7em;color:var(--accent-gold);">S&P 500</span></div>
                                <div class="asset-row-provider">${asset.provider}</div>
                            </div>
                            <div class="asset-row-return ${rCls}">${s(rPct)}${rPct.toFixed(1)}%</div>
                            <div class="asset-row-values">
                                <div class="asset-row-amount">â‚ª${vILS.toLocaleString('he-IL', {maximumFractionDigits: 0})}</div>
                                <div class="asset-row-sub">$${vUSD.toLocaleString('en-US', {maximumFractionDigits: 2})}</div>
                            </div>
                            <div class="asset-row-chevron">â–¼</div>
                        </div>
                        <div class="asset-row-expand">
                            <div class="asset-row-details">
                                <div class="asset-row-detail">
                                    <span class="asset-row-detail-label">×™×—×™×“×•×ª</span>
                                    <span class="asset-row-detail-value">${units.toFixed(3)}</span>
                                </div>
                                <div class="asset-row-detail">
                                    <span class="asset-row-detail-label">××—×™×¨ ×¨×›×™×©×”</span>
                                    <span class="asset-row-detail-value">$${avgP.toFixed(2)}</span>
                                </div>
                                <div class="asset-row-detail">
                                    <span class="asset-row-detail-label">××—×™×¨ × ×•×›×—×™</span>
                                    <span class="asset-row-detail-value" style="color:var(--accent-green);">$${curP.toFixed(2)}</span>
                                </div>
                                <div class="asset-row-detail">
                                    <span class="asset-row-detail-label">×©×¢×¨ $/â‚ª</span>
                                    <span class="asset-row-detail-value">â‚ª${exchangeRate.toFixed(4)}</span>
                                </div>
                                <div class="asset-row-detail">
                                    <span class="asset-row-detail-label">×¨×•×•×— $</span>
                                    <span class="asset-row-detail-value" style="color:${c(profitUSD)};">${s(profitUSD)}$${Math.abs(profitUSD).toLocaleString('en-US',{maximumFractionDigits:2})}</span>
                                </div>
                                <div class="asset-row-detail">
                                    <span class="asset-row-detail-label">×¨×•×•×— â‚ª</span>
                                    <span class="asset-row-detail-value" style="color:${c(profitILS)};">${s(profitILS)}â‚ª${Math.abs(profitILS).toLocaleString('he-IL',{maximumFractionDigits:0})}</span>
                                </div>
                            </div>
                            <div class="spy-daily-bar">
                                <div class="spy-daily-item">
                                    <span class="spy-daily-label">SPY ×™×•××™</span>
                                    <span class="spy-daily-value" style="color:${c(spyDPct)};">${s(spyDPct)}${spyDPct.toFixed(2)}%</span>
                                </div>
                                <div class="spy-daily-item">
                                    <span class="spy-daily-label">$/â‚ª ×™×•××™</span>
                                    <span class="spy-daily-value" style="color:${c(ilsDPct)};">${s(ilsDPct)}${ilsDPct.toFixed(2)}%</span>
                                </div>
                                <div class="spy-daily-item" style="margin-right:auto;">
                                    <span class="spy-daily-label">×ª×©×•××” ×™×•××™×ª â‚ª</span>
                                    <span class="spy-daily-value" style="color:${c(combPct)};">${s(combPct)}${combPct.toFixed(2)}% (${s(dailyILS)}â‚ª${Math.abs(dailyILS).toLocaleString('he-IL',{maximumFractionDigits:0})})</span>
                                </div>
                            </div>
                            ${editBtn}
                        </div>
                    </div>`;
                }
                
                // ===== REGULAR ASSET =====
                const valueInUSD = currency === 'USD' ? asset.value : (currency === 'ILS' ? asset.value / exchangeRate : valueInILS / exchangeRate);
                const showUSD = (asset.type === 'pension' || asset.type === 'gemel' || asset.type === 'fund') && currency === 'ILS';
                const monthlyInILS = toILS(asset.monthly || 0, currency);
                const iconBg = asset.type === 'crypto' ? 'rgba(168,85,247,0.1)' : asset.type === 'pension' || asset.type === 'gemel' ? 'rgba(0,217,255,0.1)' : asset.type === 'fund' ? 'rgba(244,196,48,0.1)' : 'rgba(255,255,255,0.04)';
                const currencyName = currency === 'USD' ? '×“×•×œ×¨' : currency === 'BTC' ? '×‘×™×˜×§×•×™×Ÿ' : currency === 'ETH' ? '××™×ª×¨×™×•×' : '×©×§×œ';
                
                return `
                <div class="asset-row" data-asset-id="${asset.id}" style="animation-delay:${delay}s" onclick="toggleAssetExpand(${asset.id})">
                    <div class="asset-row-main">
                        <div class="asset-row-icon" style="background:${iconBg};">${icon}</div>
                        <div class="asset-row-info">
                            <div class="asset-row-name">${asset.name}</div>
                            <div class="asset-row-provider">${asset.provider} â€¢ ${typeName}</div>
                        </div>
                        <div class="asset-row-return ${retClass}">${retSign}${retPct}%</div>
                        <div class="asset-row-values">
                            <div class="asset-row-amount">â‚ª${valueInILS.toLocaleString('he-IL', {maximumFractionDigits: 0})}</div>
                            ${showUSD ? `<div class="asset-row-sub">$${valueInUSD.toLocaleString('en-US', {maximumFractionDigits: 2})}</div>` : ''}
                            ${currency !== 'ILS' && !showUSD ? `<div class="asset-row-sub">${formatAmount(asset.value, currency)}</div>` : ''}
                        </div>
                        <div class="asset-row-chevron">â–¼</div>
                    </div>
                    <div class="asset-row-expand">
                        <div class="asset-row-details">
                            <div class="asset-row-detail">
                                <span class="asset-row-detail-label">×¡×•×’ × ×›×¡</span>
                                <span class="asset-row-detail-value">${typeName}</span>
                            </div>
                            <div class="asset-row-detail">
                                <span class="asset-row-detail-label">××˜×‘×¢</span>
                                <span class="asset-row-detail-value">${currencyName}</span>
                            </div>
                            <div class="asset-row-detail">
                                <span class="asset-row-detail-label">×ª×©×•××” ×©× ×ª×™×ª</span>
                                <span class="asset-row-detail-value ${retClass}">${retSign}${retPct}%</span>
                            </div>
                            ${showUSD ? `<div class="asset-row-detail">
                                <span class="asset-row-detail-label">×©×•×•×™ ×‘×“×•×œ×¨</span>
                                <span class="asset-row-detail-value">$${valueInUSD.toLocaleString('en-US', {maximumFractionDigits: 2})}</span>
                            </div>` : ''}
                            ${asset.monthly > 0 ? `<div class="asset-row-detail">
                                <span class="asset-row-detail-label">×”×¤×§×“×” ×—×•×“×©×™×ª</span>
                                <span class="asset-row-detail-value">â‚ª${monthlyInILS.toLocaleString('he-IL', {maximumFractionDigits: 0})}</span>
                            </div>` : ''}
                            ${asset.monthly > 0 ? `<div class="asset-row-detail">
                                <span class="asset-row-detail-label">×”×¤×§×“×” ×©× ×ª×™×ª</span>
                                <span class="asset-row-detail-value">â‚ª${(monthlyInILS * 12).toLocaleString('he-IL', {maximumFractionDigits: 0})}</span>
                            </div>` : ''}
                        </div>
                        ${editBtn}
                    </div>
                </div>`;
            }).join('');
        }

        function updateChart() {
            const total = assets.reduce((sum, a) => sum + toILS(a.value, a.currency || 'ILS'), 0);
            if (total === 0) {
                document.getElementById('donutChart').innerHTML = '';
                document.getElementById('legend').innerHTML = '<p style="color: var(--text-secondary); text-align: center;">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”</p>';
                return;
            }

            // Group by type
            const grouped = {};
            assets.forEach(asset => {
                if (!grouped[asset.type]) {
                    grouped[asset.type] = 0;
                }
                grouped[asset.type] += toILS(asset.value, asset.currency || 'ILS');
            });

            // Create donut chart
            let currentAngle = 0;
            const radius = 40;
            const center = 50;
            let segments = '';

            Object.entries(grouped).forEach(([type, value]) => {
                const percent = (value / total) * 100;
                const angle = (percent / 100) * 360;
                const largeArc = angle > 180 ? 1 : 0;
                
                const startX = center + radius * Math.cos((currentAngle - 90) * Math.PI / 180);
                const startY = center + radius * Math.sin((currentAngle - 90) * Math.PI / 180);
                const endX = center + radius * Math.cos((currentAngle + angle - 90) * Math.PI / 180);
                const endY = center + radius * Math.sin((currentAngle + angle - 90) * Math.PI / 180);

                segments += `
                    <path class="donut-segment" d="
                        M ${center} ${center}
                        L ${startX} ${startY}
                        A ${radius} ${radius} 0 ${largeArc} 1 ${endX} ${endY}
                        Z
                    " fill="${assetColors[type]}" opacity="0.9"/>
                `;

                currentAngle += angle;
            });

            // Add center circle
            segments += `<circle cx="${center}" cy="${center}" r="25" fill="var(--bg-card)"/>`;

            document.getElementById('donutChart').innerHTML = segments;

            // Update legend
            const legendHTML = Object.entries(grouped)
                .sort((a, b) => b[1] - a[1])
                .map(([type, value]) => {
                    const percent = ((value / total) * 100).toFixed(1);
                    return `
                        <div class="legend-item">
                            <div class="legend-color" style="background: ${assetColors[type]}"></div>
                            <div class="legend-label">${assetTypeNames[type]}</div>
                            <div class="legend-value">â‚ª${value.toLocaleString('he-IL', {maximumFractionDigits: 0})}</div>
                            <div class="legend-percent">${percent}%</div>
                        </div>
                    `;
                }).join('');

            document.getElementById('legend').innerHTML = legendHTML;
        }

        // Close modal on outside click
        document.getElementById('assetModal').addEventListener('click', (e) => {
            if (e.target.id === 'assetModal') {
                closeModal();
            }
        });

        // Initialize
        loadAssets();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }

        // Install PWA prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install button after 5 seconds
            setTimeout(() => {
                if (deferredPrompt && !localStorage.getItem('pwa-installed')) {
                    const installBar = document.createElement('div');
                    installBar.style.cssText = `
                        position: fixed;
                        bottom: 20px;
                        left: 50%;
                        transform: translateX(-50%);
                        background: linear-gradient(135deg, var(--accent-gold) 0%, #ffd700 100%);
                        color: var(--bg-primary);
                        padding: 15px 30px;
                        border-radius: 50px;
                        box-shadow: 0 10px 30px rgba(244, 196, 48, 0.4);
                        z-index: 10000;
                        cursor: pointer;
                        font-weight: 600;
                        animation: slideUp 0.5s ease-out;
                        max-width: 90%;
                        text-align: center;
                    `;
                    installBar.innerHTML = 'ğŸ“± ×”×ª×§×Ÿ ××ª ×”××¤×œ×™×§×¦×™×” ×‘××›×©×™×¨';
                    installBar.onclick = () => {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                localStorage.setItem('pwa-installed', 'true');
                            }
                            deferredPrompt = null;
                            installBar.remove();
                        });
                    };
                    document.body.appendChild(installBar);
                }
            }, 5000);
        });
    </script>
</body>
</html>